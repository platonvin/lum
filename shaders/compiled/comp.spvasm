; SPIR-V
; Version: 1.0
; Generator: Google Shaderc over Glslang; 11
; Bound: 1388
; Schema: 0
               OpCapability Shader
               OpCapability StorageImageExtendedFormats
               OpCapability ImageQuery
          %2 = OpExtInstImport "GLSL.std.450"
               OpMemoryModel Logical GLSL450
               OpEntryPoint GLCompute %main "main" %gl_GlobalInvocationID
               OpExecutionMode %main LocalSize 8 8 1
          %1 = OpString "shaders/comp.comp"
               OpSource GLSL 450 %1 "// OpModuleProcessed entry-point main
// OpModuleProcessed client vulkan100
// OpModuleProcessed target-env vulkan1.0
// OpModuleProcessed entry-point main
#line 1
#version 450 core

precision highp int;
precision highp float;

// #define DEBUG

layout(push_constant) uniform constants{
    int timeSeed;
} PushConstants;
//descriptor bindings for the pipeline
layout(set = 0, binding = 0, rgba32f) readonly uniform image2D posMat;
layout(set = 0, binding = 1, rgba32f) readonly uniform image2D norms;
layout(set = 0, binding = 2, rgba32f) readonly uniform image2D diffs;
layout(set = 0, binding = 3, r32i) uniform iimage3D blocks;
layout(set = 0, binding = 4, r8ui) uniform uimage3D blockPalette;
layout(set = 0, binding = 5, r32f) readonly uniform image2D voxelPalette;
layout(set = 0, binding = 6, rgba8) uniform   image2D frame;
layout(set = 0, binding = 7       ) uniform sampler2D frame_sampler;

const vec3 cameraRayDir = normalize(vec3(0.1, 1.0, -0.5));
const vec3 cameraPos = vec3(60, 0, 50);
// vec3 cameraRayDir = normalize(vec3(-1, 0, .1));
// vec3 cameraRayDir = normalize(vec3(12, 21, 7));
// vec3 cameraRayDir = normalize(vec3(1, 1, 0));
const vec3 globalLightDir = normalize(vec3(0.5, 1, -0.5));
// vec3 globalLightDir = cameraRayDir;
const vec3 cameraRayDirPlane = normalize(vec3(cameraRayDir.xy, 0));
const vec3 horizline = normalize(cross(cameraRayDirPlane, vec3(0,0,1)));
const vec3 vertiline = normalize(cross(cameraRayDir, horizline));

// vec3 cameraPos = vec3(-13, -22, -8)*1.5/16.0;

const int BLOCK_PALETTE_SIZE_X = 32;
#define MAX_DEPTH 3
#define NUM_SAMPLES 1
#define PI 3.1415926535
#define FAR_DISTANCE 100000.0
#define nIN 1.0
#define nOUT 1.0

#define WIDTH_B  (8)
#define LENGTH_B (8)
#define HEIGHT_B (8)

vec3 randvec;

const float view_width  = 1920.0 / 42.0; //in block_diags
const float view_height = 1080.0 / 42.0; //in blocks

struct Material{
    vec3 color; //for each color
    float emmitance;
    float smoothness;
    float transparancy;
};

uint hash3(uint x, uint y, uint z) {
    x += x >> 11;
    x ^= x << 7;
    x += y;
    x ^= x << 3;
    x += z ^ (x >> 14);
    x ^= x << 6;
    x += x >> 15;
    x ^= x << 5;
    x += x >> 12;
    x ^= x << 9;
    return x;
}

float random(vec3 f) {
  uint mantissaMask = 0x007FFFFFu;
  uint one = 0x3F800000u;
  uvec3 u = floatBitsToUint(f);
  uint h = hash3(u.x, u.y, u.z);
  return uintBitsToFloat((h & mantissaMask) | one) - 1.0;
}

float RandomNoise(){
  uint mantissaMask = 0x007FFFFFu;
  uint one = 0x3F800000u;
  uvec3 u = floatBitsToUint(randvec);
  uint h = hash3(u.x, u.y, u.z);
  float res = uintBitsToFloat((h & mantissaMask) | one) - 1.0;

  randvec.x = sin(randvec.y);
  randvec.y = sin(randvec.z);
  randvec.z = sin(res);
  
  return (sin(res));
}

float RandomFloat_0to1(){
    return RandomNoise();
}

vec2 Random2D(){
    return normalize(vec2(RandomNoise(), RandomNoise()));
}

uvec3 pcg3d(uvec3 v) {
  v = v * 1664525u + 1013904223u;
  v.x += v.y * v.z;
  v.y += v.z * v.x;
  v.z += v.x * v.y;
  v ^= v >> 16u;
  v.x += v.y * v.z;
  v.y += v.z * v.x;
  v.z += v.x * v.y;
  return v;
}
vec3 Random3D() {
    randvec = uintBitsToFloat((pcg3d(floatBitsToUint(randvec)) & 0x007FFFFFu) | 0x3F800000u) - 1.0;
    return randvec;
}

vec3 randomSpherePoint(vec3 rand) {
    float ang1 = (rand.x + 1.0) * PI; // [-1..1) -> [0..2*PI)
    float u = rand.y; // [-1..1), cos and acos(2v-1) cancel each other out, so we arrive at [-1..1)
    float u2 = u * u;
    float sqrt1MinusU2 = sqrt(1.0 - u2);
    float x = sqrt1MinusU2 * cos(ang1);
    float y = sqrt1MinusU2 * sin(ang1);
    float z = u;
    return vec3(x, y, z);
}

vec3 NormalOrientedHemispherePoint(vec3 rand, vec3 n){
    vec3 v = randomSpherePoint(rand);
    return v * sign(dot(v, n));
}

vec3 randomCosineWeightedHemispherePoint(vec3 rand, vec3 n) {
  float r = rand.x * 0.5 + 0.5; // [-1..1) -> [0..1)
  float angle = (rand.y + 1.0) * PI; // [-1..1] -> [0..2*PI)
  float sr = sqrt(r);
  vec2 p = vec2(sr * cos(angle), sr * sin(angle));
  /*
   * Unproject disk point up onto hemisphere:
   * 1.0 == sqrt(x*x + y*y + z*z) -> z = sqrt(1.0 - x*x - y*y)
   */
  vec3 ph = vec3(p.xy, sqrt(1.0 - p*p));
  /*
   * Compute some arbitrary tangent space for orienting
   * our hemisphere 'ph' around the normal. We use the camera's up vector
   * to have some fix reference vector over the whole screen.
   */
  vec3 tangent = normalize(rand);
  vec3 bitangent = cross(tangent, n);
  tangent = cross(bitangent, n);
  
  /* Make our hemisphere orient around the normal. */
  return tangent * ph.x + bitangent * ph.y + n * ph.z;
}
vec3 get_origin_from_depth(float depth, vec2 pix_pos){
    vec3 pos = vec3(0);
    
    pos = cameraPos + 
        (horizline*pix_pos.x*view_width ) + 
        (vertiline*pix_pos.y*view_height) + 
        (depth*cameraRayDir);
    
    return pos;
}
//pos is in voxels
int GetBlock(in ivec3 block_pos){
    int block;
#ifdef DEBUG
if (block_pos.x < 0 || block_pos.x >=8) return 0;
if (block_pos.y < 0 || block_pos.y >=8) return 0;
if (block_pos.z < 0 || block_pos.z >=8) return 0;
#endif


    block = int((imageLoad(blocks, block_pos).r));
#ifdef DEBUG
if (block_pos.z == 0) block = 0;    
if (block_pos.z == 1) block = 0;    
if (block_pos.z == 2) block = 0;    
#endif

    return block;
}

ivec3 voxel_in_palette(ivec3 relative_voxel_pos, int block_id) {
    int block_x = block_id % BLOCK_PALETTE_SIZE_X;
    int block_y = block_id / BLOCK_PALETTE_SIZE_X;

    return relative_voxel_pos + ivec3(16*block_x, 16*block_y, 0);
}
int GetVoxel(in ivec3 pos){
    int voxel;

#ifdef DEBUG
if (pos.x < 0 || pos.x >= 16* WIDTH_B) return 0;
if (pos.y < 0 || pos.y >= 16*LENGTH_B) return 0;
if (pos.z < 0 || pos.z >= 16*HEIGHT_B) return 0;
#endif
    ivec3 block_pos = pos / 16;
    ivec3 relative_voxel_pos = pos % 16;

    int block_id = GetBlock(block_pos);
    ivec3 voxel_pos = voxel_in_palette(relative_voxel_pos, block_id);
    
    voxel = int(imageLoad(blockPalette, voxel_pos).r);

    return voxel;
}
void SetVoxel(in ivec3 pos, in uint voxel){
#ifdef DEBUG
if (pos.x < 0 || pos.x >= 16* WIDTH_B) return;
if (pos.y < 0 || pos.y >= 16*LENGTH_B) return;
if (pos.z < 0 || pos.z >= 16*HEIGHT_B) return;
#endif
    
    ivec3 block_pos = pos / 16;
    ivec3 relative_voxel_pos = pos % 16;

    int block_id = GetBlock(block_pos);
    ivec3 voxel_pos = voxel_in_palette(relative_voxel_pos, block_id);
    
    imageStore(blockPalette, voxel_pos, uvec4(voxel));
}

Material GetMat(in int voxel){
    Material mat;

    // mat.emmitance = 0.1;
    // mat.smoothness = 0.5;


    mat.color.r      = imageLoad(voxelPalette, ivec2(0,voxel)).r;
    mat.color.g      = imageLoad(voxelPalette, ivec2(1,voxel)).r;
    mat.color.b      = imageLoad(voxelPalette, ivec2(2,voxel)).r;
    mat.transparancy = 1.0 - imageLoad(voxelPalette, ivec2(3,voxel)).r;
    mat.emmitance    =       imageLoad(voxelPalette, ivec2(4,voxel)).r;
    mat.smoothness   =       imageLoad(voxelPalette, ivec2(5,voxel)).r;
    // mat.emmitance    = 0.1;    
    // mat.color = mat.color/2 + 0.5;
    // mat.emmitance=mat.color;
    // mat.color=vec3(0);
    // mat.color = vec3(.6,.8,.3);
    // mat.transparancy = 0.0;
    // mat.color = vec3(8,9,10)/14;
    // mat.smoothness   = .2;
    // mat.emmitance    = 0.2;
    mat.transparancy = 0;
    mat.smoothness   = .5;
    // mat.transparancy = 0;
    // if (voxel == 154) {
        // mat.color = vec3(255, 0, 0) / 256.0;
    //     mat.emmitance = 0.01;
    //     mat.smoothness = 0.1;
    //     mat.color = vec3(.9,.85,.87);
    // }
    // if (voxel == 165) {
    //     mat.color = vec3(12, 255, 34) / 256.0;
    //     mat.emmitance = 0.9;
    //     mat.smoothness = 0.5;
    // } else
    // if (voxel == 156) {
    //     mat.color = vec3(50, 50, 255) / 256.0;
    //     mat.emmitance = 0.5;
    //     mat.smoothness = 0.2;
    // }
    // // mat.smoothness = 1.0;
return mat;
}

// bool InsideScene(in vec3 rayOrigin){
//     vec3 corner_1 = vec3(0, 0, 0);
//     vec3 corner_2 = vec3(WIDTH, LENGTH, HEIGHT);

//     vec3 s = step(corner_1, rayOrigin) - step(corner_2, rayOrigin); //if we are inside of the box

//     if (s.x * s.y * s.z == 0.0) return false;

//     return true;
// }

// bool InsideScene_byBlockPos(in ivec3 block_pos){
//     ivec3 corner_1 = ivec3(0, 0, 0);
//     ivec3 corner_2 = ivec3(WIDTH, LENGTH, HEIGHT);

//     vec3 s = step(corner_1, block_pos) - step(corner_2, block_pos); //if we are inside of the box

//     if (s.x * s.y * s.z == 0) return false;

//     return true;
// }

bool initTvals(out vec3 tMax, out vec3 tDelta, out ivec3 blockPos, in vec3 rayOrigin, in vec3 rayDirection){
    vec3 effective_origin = rayOrigin;

    vec3 block_corner1 = floor(effective_origin); //not real center
    vec3 block_corner2 = block_corner1 + vec3(1.0); //now real center

    blockPos = ivec3(block_corner1); //round origin to block pos
    // blockPos = ivec3(block_corner1)*16; //round origin to block pos

    block_corner1 -= effective_origin; //now corners are relative vectors
    block_corner2 -= effective_origin;

    block_corner1 /= rayDirection; //now corners are in relative direction vectors
    block_corner2 /= rayDirection;

    tMax.x = max(block_corner1.x, block_corner2.x); //1 of theese will be negative so max is just to get positive
    tMax.y = max(block_corner1.y, block_corner2.y);
    tMax.z = max(block_corner1.z, block_corner2.z);

    tDelta = 1.0 / abs(rayDirection); //how many dir vectors needeed to move 1.0 across each axys

    return true;
}

// void CollideInsideBlock(in vec3 rayOrigin, in vec3 rayDirection, out float fraction, out vec3 normal, in ivec3 block_pos){
//     vec3 corner_1 = vec3(block_pos);
//     vec3 corner_2 = vec3(block_pos) + vec3(1.0);

//     vec3 planes_1 = (corner_1 - rayOrigin) / rayDirection;
//     vec3 planes_2 = (corner_2 - rayOrigin) / rayDirection;

//     vec3 fractionsForAxis;
//     fractionsForAxis.x = max(planes_1.x, planes_2.x);
//     fractionsForAxis.y = max(planes_1.y, planes_2.y);
//     fractionsForAxis.z = max(planes_1.z, planes_2.z);

//     ivec3 steps;
//     steps.x = (rayDirection.x < 0) ? -1 : +1;
//     steps.y = (rayDirection.y < 0) ? -1 : +1;
//     steps.z = (rayDirection.z < 0) ? -1 : +1;

//     if (fractionsForAxis.x < fractionsForAxis.y) {
//         if (fractionsForAxis.x < fractionsForAxis.z) {
//             fraction = fractionsForAxis.x;
//             normal = vec3(-1.0, 0, 0) * float(steps.x);
//         }
//         else { //z is the lowest
//             fraction = fractionsForAxis.z;
//             normal = vec3(0, 0, -1.0) * float(steps.z);
//         }
//     } else {
//         if (fractionsForAxis.y < fractionsForAxis.z) {
//             fraction = fractionsForAxis.y;
//             normal = vec3(0, -1.0, 0) * float(steps.y);
//         }
//         else { //z is the lowest
//             fraction = fractionsForAxis.z;
//             normal = vec3(0, 0, -1.0) * float(steps.z);
//         }
//     }
// }
// bool Cast_Ray(in vec3 origin, in vec3 dir, out float fraction, out vec3 normal, out Material mat) {
//     bool hit = false;
//     ivec3 isteps;
//     isteps.x = int(dir.x > 0.0);
//     isteps.y = int(dir.y > 0.0);
//     isteps.z = int(dir.z > 0.0);
//     isteps = ivec3(2) * isteps - ivec3(1);
//     vec3 fsteps;
//     fsteps.x = float(dir.x > 0.0);
//     fsteps.y = float(dir.y > 0.0);
//     fsteps.z = float(dir.z > 0.0);
//     fsteps = 2.0 * fsteps - 1.0;

//     vec3 tMax = vec3(0);
//     vec3 tDelta = vec3(0);
//     vec3 fcurrentStepDiretion = vec3(0);
//     ivec3 icurrentStepDiretion = ivec3(0);
//     ivec3 currentVoxelPos = ivec3(0);
//     int currentVoxel = 0;
//     fraction = 0;

//     if (!initTvals(origin, dir, tMax, tDelta, currentVoxelPos)) return false; //does not intersect with scene

//     currentVoxel = GetVoxel(currentVoxelPos);
//     int iterations = 0;
//     while (true) {
//         icurrentStepDiretion.x = int(tMax.x < tMax.y && tMax.x < tMax.z);
//         icurrentStepDiretion.y = int(tMax.x > tMax.y && tMax.y < tMax.z);
//         icurrentStepDiretion.z = int(tMax.z < tMax.x && tMax.z < tMax.y);

//         fcurrentStepDiretion.x = float(int((tMax.x <= tMax.y) && (tMax.x <= tMax.z)));
//         fcurrentStepDiretion.y = float(int((tMax.x >= tMax.y) && (tMax.y <= tMax.z)));
//         fcurrentStepDiretion.z = float(int((tMax.z <= tMax.x) && (tMax.z <= tMax.y)));

//         currentVoxelPos += isteps * icurrentStepDiretion;
//         fraction += dot(tDelta, fcurrentStepDiretion);
//         tMax += (tDelta * fcurrentStepDiretion);

//         currentVoxel = GetVoxel(currentVoxelPos);
//         // currentBlock = Get_Block(currentVoxelPos);

//         if (currentVoxel != 0) {
//             hit = true;
//             break;
//         }

//         if (iterations++ > 128) {
//             hit = false;
//             break;
//         }
//     }
//     ;

//     normal = -(fsteps * fcurrentStepDiretion);
//     mat = GetMat(currentVoxel);

//     return hit;
// }
bool CastRay(in vec3 rayOrigin, in vec3 rayDirection, out float fraction, out vec3 normal, out Material material, float ignored_voxel){
    bool block_hit = false;

    ivec3 steps;
    steps.x = int(rayDirection.x > 0.0);
    steps.y = int(rayDirection.y > 0.0);
    steps.z = int(rayDirection.z > 0.0);
    steps = 2 * steps - 1;

    vec3 fsteps = vec3(steps);

    vec3 tMax = vec3(0);
    vec3 tDelta = vec3(0);
    ivec3 voxel_pos = ivec3(0);
    float block_fraction = 0.0;

    lowp int What_Is_Step = 0;
    ivec3 istep_Diretion = ivec3(0);
    vec3 fcurrentStepDiretion = vec3(0);

    if (!initTvals(tMax, tDelta, voxel_pos, rayOrigin, rayDirection)) return false; //does not intersect with scene

    int current_voxel = GetVoxel(voxel_pos);
    int iterations = 0;
    while (true) {
        // fstep_Diretion =  vec3(0);
        fcurrentStepDiretion.x = float(int((tMax.x <= tMax.y) && (tMax.x <= tMax.z)));
        fcurrentStepDiretion.y = float(int((tMax.x >= tMax.y) && (tMax.y <= tMax.z)));
        fcurrentStepDiretion.z = float(int((tMax.z <= tMax.x) && (tMax.z <= tMax.y)));

        voxel_pos += steps * ivec3(fcurrentStepDiretion);
        tMax += tDelta * fcurrentStepDiretion;

        current_voxel = GetVoxel(voxel_pos);

        // if (any(lessThan(voxel_pos,ivec3(0))) || any(greaterThanEqual(voxel_pos,imageSize(blocks)*16))) {
        if (any(lessThan(voxel_pos,ivec3(0))) || any(greaterThanEqual(voxel_pos,ivec3(8*16)))) {
            block_hit = false;
            break;
        }
        if ((current_voxel != 0) 
        // && !((current_voxel == ignored_voxel) && (iterations < 1))
        ){
            block_hit = true;
            break;
        }
        if (iterations++ >= 100) {
            block_hit = false;
            break;
        }
    }

    normal = -(fsteps * fcurrentStepDiretion);
    vec3 tFinal = tMax - tDelta;
    // block_fraction += dot(tFinal, fcurrentStepDiretion);
    block_fraction = dot(tFinal, fcurrentStepDiretion);

    material = GetMat(current_voxel);
    fraction = block_fraction;

    return (block_hit);
}

float FresnelSchlick(in vec3 direction, in vec3 normal){
    float nIn = nIN;
    float nOut = nOUT;
    float R0 = ((nOut - nIn) * (nOut - nIn)) / ((nOut + nIn) * (nOut + nIn));
    float fresnel = R0 + (1.0 - R0) * pow((1.0 - abs(dot(direction, normal))), 5.0);
    return fresnel;
}
vec3 IdealRefract(vec3 direction, vec3 normal, float nIn, float nOut){
    // ะะะะ, ะะะะั ะธัฒะัะะ    // ะตปะ - ัผั ะััะะตะฝฟฐปฝัะ    bool fromOutside = dot(normal, direction) < 0.0;
    float ratio = fromOutside ? nOut / nIn : nIn / nOut;

    vec3 refraction, reflection;
    refraction = fromOutside ? refract(direction, normal, ratio) : -refract(-direction, normal, ratio);
    reflection = reflect(direction, normal);

    // ะฐะะะะฒฝพพัะะะ refract ะตฝะ 0.0
    return refraction == vec3(0.0) ? reflection : refraction;
}
bool IsRefracted(in vec3 rayDirection, in vec3 normal, in float transparancy){
    float fresnel = FresnelSchlick(rayDirection, normal);
    float rand = RandomFloat_0to1();
    return (transparancy > rand) && (fresnel < rand); // && transparancy == 0.0;
}

void ProcessHit(inout vec3 origin, inout vec3 direction, 
                in float fraction, in vec3 normal, in Material material, 
                inout vec3 accumulated_light, inout vec3 accumulated_reflection){

            vec3 new_origin = origin + (fraction * direction);

            // vec3 hemisphereDistributedDirection = NormalOrientedHemispherePoint(Random3D(), normal);
            vec3 hemisphereDistributedDirection = randomCosineWeightedHemispherePoint(Random3D(), normal);
            // vec3 randomVec = normalize(2.0 * Random3D() - 1.0);
            // vec3 tangent = cross(randomVec, normal);
            // vec3 bitangent = cross(normal, tangent);
            // mat3 transform = mat3(tangent, bitangent, normal);

            vec3 new_direction = hemisphereDistributedDirection;

            bool refracted = IsRefracted(direction, normal, material.transparancy);
            refracted = false;//TODO:
            if (refracted)
            {
                vec3 idealRefraction = IdealRefract(direction, normal, nIN, nOUT);
                new_direction = normalize(mix(-new_direction, idealRefraction, material.smoothness));
                // newRayDirection = normalize(mix(idealRefraction, -newRayDirection, material.smoothness));
                new_origin += normal * (dot(new_direction, normal) < 0.0 ? -0.001 : 0.001);
            }
            else
            {
                vec3 idealReflection = reflect(direction, normal);
                new_direction = normalize(mix(new_direction, idealReflection, material.smoothness));
                new_origin += normal * 0.001;
                accumulated_reflection *= material.color;
                accumulated_light += accumulated_reflection * material.emmitance;
                // accumulated_light += vec3(0.8) * 0.1 * accumulated_reflection;
            }

// ivec2 pix = ivec2(gl_GlobalInvocationID.xy);
// imageStore(frame, pix, vec4(vec3(dot(normal, new_direction)<0),1));
            // direction = reflect(direction,normal);
            direction = new_direction;
            origin = new_origin;

}

vec3 TraceRay(in vec3 rayOrigin, in vec3 rayDirection, in vec3 accumulated_light, in vec3 accumulated_reflection, in float ignored_voxel){
    // vec3 accumulated_light = vec3(0.0);
    // vec3 accumulated_reflection = vec3(1.0);

    float fraction = 0;
    vec3 normal = vec3(0);
    Material material;

    for (int i = 0; i < MAX_DEPTH; i++)
    {
        bool hit = CastRay(rayOrigin, rayDirection, fraction, normal, material, ignored_voxel);
        ignored_voxel = 999.0;
        if (hit)
        {
            // return vec3(material.color);
            ProcessHit(rayOrigin, rayDirection, 
                fraction, normal, material, 
                accumulated_light, accumulated_reflection);
            // if (length(rayDirection) <= 15) return vec3(1);
            // vec3 newRayOrigin = rayOrigin + (fraction * rayDirection);

            // vec3 hemisphereDistributedDirection = NormalOrientedHemispherePoint(Random3D(), normal);
            // // vec3 randomVec = normalize(2.0 * Random3D() - 1.0);

            // // vec3 tangent = cross(randomVec, normal);
            // // vec3 bitangent = cross(normal, tangent);
            // // mat3 transform = mat3(tangent, bitangent, normal);

            // // vec3 newRayDirection = transform * hemisphereDistributedDirection;
            // vec3 newRayDirection = hemisphereDistributedDirection;

            // bool refracted = IsRefracted(rayDirection, normal, material.transparancy);
            // refracted=false;
            // if (refracted)
            // {
            //     vec3 idealRefraction = IdealRefract(rayDirection, normal, nIN, nOUT);
            //     newRayDirection = normalize(mix(-newRayDirection, idealRefraction, material.smoothness));
            //     // newRayDirection = normalize(mix(idealRefraction, -newRayDirection, material.smoothness));
            //     newRayOrigin += normal * (dot(newRayDirection, normal) < 0.0 ? -0.001 : 0.001);
            // }
            // else
            // {
            //     vec3 idealReflection = reflect(rayDirection, normal);
            //     newRayDirection = normalize(mix(newRayDirection, idealReflection, material.smoothness));
            //     newRayOrigin += normal * 0.001;
            //     accumulated_light += accumulated_reflection * material.emmitance * material.color;
            //     accumulated_reflection *= material.color;
            //     // accumulated_light += vec3(0.8) * 0.2 * accumulated_reflection;
            // }

            // rayDirection = newRayDirection;
            // rayOrigin = newRayOrigin;
        }
        if(length(accumulated_reflection) < 0.01 || length(accumulated_light) > sqrt(3.0)) {break;}
        else {
            break;
        }
    }

    float global_light_participance = -dot(rayDirection, globalLightDir);
    if (global_light_participance > 0.0) {
        accumulated_light += (vec3(.9,.9,.6)/2) * accumulated_reflection * global_light_participance;
    }

    return accumulated_light;   
}


vec3 rotateAxis(vec3 p, vec3 axis, float angle) {
    return mix(dot(axis, p) * axis, p, cos(angle)) + cross(axis, p) * sin(angle);
}

float load_depth(ivec2 pixel){
    return imageLoad(posMat, ivec2(pixel)).x;
}
vec3 load_norm(ivec2 pixel){
    return imageLoad(norms, ivec2(pixel)).xyz;
}
bool ssr_intersects(in float test_depth, in vec2 pix, inout bool smooth_intersection){
    float depth = load_depth(ivec2(pix));
    float diff = test_depth - depth;
    bool ssr = false;
    smooth_intersection = false;
    if(diff > 0.0)    {ssr = true;}
    if(diff < 1.0) {smooth_intersection = true;}
    // smooth_intersection = true;
    return ssr;
}
bool ssr_traceRay(in vec3 origin, in vec3 direction, in vec2 start_pix, out float fraction, out vec3 normal, out Material material){

    int counter=0;
    //vertical component of direction relative to camera plane

    //for every 1 parrallel to camera plane this much depth
    // float delta_depth = dot(cameraRayDir, direction);
    // vec3 delta_ssr_pos = direction;
    // vec2 delta_ssr_pix; 
    //      delta_ssr_pix.x = dot(direction, horizline)*view_width ;
    //      delta_ssr_pix.y = dot(direction, vertiline)*view_height;

    // float div = 10.0;
        
    bool smooth_intersection = false;
    float fraction_step = 0.1;
    
    fraction = 0.0;

    vec2 pix = start_pix;
    float depth = 0;
    while(true){
        //make step
        fraction += fraction_step;
        vec3 new_origin = origin + direction*fraction;
        vec3 relative_pos = new_origin - cameraPos;
        depth = dot(relative_pos, cameraRayDir);
        pix.x = ((dot(relative_pos, horizline)/view_width )/2.0 +0.5)*imageSize(posMat).x;
        pix.y = ((dot(relative_pos, vertiline)/view_height)/2.0 +0.5)*imageSize(posMat).y;

        // counter++;
        
        if (ssr_intersects(depth, pix, smooth_intersection)) {

            // smooth_intersection = false;
            // if(dot(imageLoad(norms, ivec2(pix)).xyz, direction) < -0.5) {smooth_intersection = true;}
            
            if(smooth_intersection){
                normal = load_norm(ivec2(pix));
                material = GetMat(int(imageLoad(posMat, ivec2(pix)).w));
                return true;
            } else {
                fraction -= fraction_step;
                return false;
            }
            
            //return fraction
        }
        if (fraction > 2.0) return false;
    }
}

//TODO: balance
layout(local_size_x = 8, local_size_y = 8) in;

// float inv(float f){
//     return  ()
// }

void main(void){
    ivec2 pix = ivec2(gl_GlobalInvocationID.xy);
    // size = 
    
    ivec2 size = imageSize(frame);
    size = ivec2(1920, 1061);
    if (pix.x >= size.x || pix.y >= size.y) {
        return;
    }

    vec2 pos = vec2(pix) / vec2(size.x - 1, size.y - 1);
    randvec = vec3(pos.y,pos.x, pos.x*pos.y) * (0.1+sin(PushConstants.timeSeed));
#ifdef DEBUG
    randvec = Random3D();
    randvec = Random3D();
#endif
    // randvec = (((randvec)));

        
    float depth = imageLoad(posMat, pix).x;
    float  fmat = imageLoad(posMat, pix).w;
    Material material = GetMat(int(fmat));
    // vec3 origin = imageLoad(posMat, pix).xyz;
    vec3 direction = cameraRayDir;
    vec3 normal = load_norm(pix);
    vec3 origin = get_origin_from_depth(depth, vec2(pos.x-0.5, pos.y-0.5)*2);

    vec3 accumulated_light      = vec3(0); 
    vec3 accumulated_reflection = vec3(1);

    // vec3 hemisphereDistributedDirection = randomCosineWeightedHemispherePoint(Random3D(), normal);
    // vec3 idealReflection = normalize(reflect(normalize(direction), normalize(normal)));
    // vec3 ndirection = normalize(mix(normalize(hemisphereDistributedDirection), idealReflection, 0.0));


    // imageStore(frame, pix, vec4((material.color),1));
    float fvoxel = GetVoxel(ivec3(origin+direction));
    fvoxel = 999.0;

    // float dist = 0.1;
    // while (dist < 0.5){
    //     SetVoxel(ivec3(origin + normal*dist), 0);
    //     dist += 0.2;
    // }
    // SetVoxel(ivec3(origin), 0);
    // SetVoxel(ivec3(origin+normal*0.5), 0);

    // origin -= cameraRayDir*10;

        // material = GetMat(GetVoxel(ivec3(origin)));
        // material.color = vec3(1);
        // material.emmitance = 1;
        // material.smoothness = 0;
        
    
    // bool switcher = true;
    bool ssr = true;
    // #pragma optionNV(unroll none)
    for(int i=0; i<2; i++){
        if(i==1){
            float fraction = 0.0;
            ssr = ssr_traceRay(origin, direction, vec2(pix), fraction, normal, material);
            origin += direction*fraction; 
            
            // if(ssr) {
            //     ProcessHit(origin, direction,
            //     0.0, normal, material,
            //     accumulated_light, accumulated_reflection); 
            // } 
        }
        if(ssr) {
            ProcessHit(origin, direction,
                0, normal, material,
                accumulated_light, accumulated_reflection);
        }
    }
    // #pragma optionNV(unroll )
    // else 
    // origin -= direction*10.0;
    
        

    // imageStore(frame, pix, vec4((GetMat(int(fvoxel)).color),1));
    // imageStore(frame, pix, vec4(vec3(dot(hemisphereDistributedDirection, idealReflection)>0),1));
    // imageStore(frame, pix, vec4(vec3(abs(hemisphereDistributedDirection)),1));
    // imageStore(frame, pix, vec4(vec3(abs(normal)),1));
    // imageStore(frame, pix, vec4(vec3(origin+direction)/256,1));

    
    // origin = -cameraRayDir*20 +vec3(40,40,70) + (pos.x-0.5) * (horizline*150) + (pos.y-0.5) * (vertiline*150) ;
    // direction = cameraRayDir;

    vec3 color = vec3(0);
    for (int samplei = 0; samplei < NUM_SAMPLES; samplei++)    {
        // vec2 posShift = 2.0 * (Random2D() - vec2(0.5)) / vec2(size);
        color += TraceRay(origin, direction, accumulated_light, accumulated_reflection, fvoxel) / NUM_SAMPLES;
    }

    vec2 old_clip = imageLoad(diffs, pix).xy;
    vec2 old_uv   = old_clip/2 + 0.5;
    // vec2 old_uv   = old_clip;
    // ivec2 pix_shift = ivec2(size * clip_shift.xy * 10);
    vec3 old_color = texture(frame_sampler, old_uv).xyz;
    color = mix(color, old_color, 0.9);
    imageStore(frame, pix, vec4(color, 1));
} "
               OpSourceExtension "GL_GOOGLE_cpp_style_line_directive"
               OpSourceExtension "GL_GOOGLE_include_directive"
               OpName %main "main"
               OpName %hash3_u1_u1_u1_ "hash3(u1;u1;u1;"
               OpName %x "x"
               OpName %y "y"
               OpName %z "z"
               OpName %RandomNoise_ "RandomNoise("
               OpName %RandomFloat_0to1_ "RandomFloat_0to1("
               OpName %pcg3d_vu3_ "pcg3d(vu3;"
               OpName %v "v"
               OpName %Random3D_ "Random3D("
               OpName %randomCosineWeightedHemispherePoint_vf3_vf3_ "randomCosineWeightedHemispherePoint(vf3;vf3;"
               OpName %rand "rand"
               OpName %n "n"
               OpName %get_origin_from_depth_f1_vf2_ "get_origin_from_depth(f1;vf2;"
               OpName %depth "depth"
               OpName %pix_pos "pix_pos"
               OpName %GetBlock_vi3_ "GetBlock(vi3;"
               OpName %block_pos "block_pos"
               OpName %voxel_in_palette_vi3_i1_ "voxel_in_palette(vi3;i1;"
               OpName %relative_voxel_pos "relative_voxel_pos"
               OpName %block_id "block_id"
               OpName %GetVoxel_vi3_ "GetVoxel(vi3;"
               OpName %pos "pos"
               OpName %Material "Material"
               OpMemberName %Material 0 "color"
               OpMemberName %Material 1 "emmitance"
               OpMemberName %Material 2 "smoothness"
               OpMemberName %Material 3 "transparancy"
               OpName %GetMat_i1_ "GetMat(i1;"
               OpName %voxel "voxel"
               OpName %initTvals_vf3_vf3_vi3_vf3_vf3_ "initTvals(vf3;vf3;vi3;vf3;vf3;"
               OpName %tMax "tMax"
               OpName %tDelta "tDelta"
               OpName %blockPos "blockPos"
               OpName %rayOrigin "rayOrigin"
               OpName %rayDirection "rayDirection"
               OpName %CastRay_vf3_vf3_f1_vf3_struct_Material_vf3_f1_f1_f11_f1_ "CastRay(vf3;vf3;f1;vf3;struct-Material-vf3-f1-f1-f11;f1;"
               OpName %rayOrigin_0 "rayOrigin"
               OpName %rayDirection_0 "rayDirection"
               OpName %fraction "fraction"
               OpName %normal "normal"
               OpName %material "material"
               OpName %ignored_voxel "ignored_voxel"
               OpName %FresnelSchlick_vf3_vf3_ "FresnelSchlick(vf3;vf3;"
               OpName %direction "direction"
               OpName %normal_0 "normal"
               OpName %IdealRefract_vf3_vf3_f1_f1_ "IdealRefract(vf3;vf3;f1;f1;"
               OpName %direction_0 "direction"
               OpName %normal_1 "normal"
               OpName %nIn "nIn"
               OpName %nOut "nOut"
               OpName %IsRefracted_vf3_vf3_f1_ "IsRefracted(vf3;vf3;f1;"
               OpName %rayDirection_1 "rayDirection"
               OpName %normal_2 "normal"
               OpName %transparancy "transparancy"
               OpName %ProcessHit_vf3_vf3_f1_vf3_struct_Material_vf3_f1_f1_f11_vf3_vf3_ "ProcessHit(vf3;vf3;f1;vf3;struct-Material-vf3-f1-f1-f11;vf3;vf3;"
               OpName %origin "origin"
               OpName %direction_1 "direction"
               OpName %fraction_0 "fraction"
               OpName %normal_3 "normal"
               OpName %material_0 "material"
               OpName %accumulated_light "accumulated_light"
               OpName %accumulated_reflection "accumulated_reflection"
               OpName %TraceRay_vf3_vf3_vf3_vf3_f1_ "TraceRay(vf3;vf3;vf3;vf3;f1;"
               OpName %rayOrigin_1 "rayOrigin"
               OpName %rayDirection_2 "rayDirection"
               OpName %accumulated_light_0 "accumulated_light"
               OpName %accumulated_reflection_0 "accumulated_reflection"
               OpName %ignored_voxel_0 "ignored_voxel"
               OpName %load_depth_vi2_ "load_depth(vi2;"
               OpName %pixel "pixel"
               OpName %load_norm_vi2_ "load_norm(vi2;"
               OpName %pixel_0 "pixel"
               OpName %ssr_intersects_f1_vf2_b1_ "ssr_intersects(f1;vf2;b1;"
               OpName %test_depth "test_depth"
               OpName %pix "pix"
               OpName %smooth_intersection "smooth_intersection"
               OpName %ssr_traceRay_vf3_vf3_vf2_f1_vf3_struct_Material_vf3_f1_f1_f11_ "ssr_traceRay(vf3;vf3;vf2;f1;vf3;struct-Material-vf3-f1-f1-f11;"
               OpName %origin_0 "origin"
               OpName %direction_2 "direction"
               OpName %start_pix "start_pix"
               OpName %fraction_1 "fraction"
               OpName %normal_4 "normal"
               OpName %material_1 "material"
               OpName %mantissaMask "mantissaMask"
               OpName %one "one"
               OpName %u "u"
               OpName %randvec "randvec"
               OpName %h "h"
               OpName %param "param"
               OpName %param_0 "param"
               OpName %param_1 "param"
               OpName %res "res"
               OpName %param_2 "param"
               OpName %r "r"
               OpName %angle "angle"
               OpName %sr "sr"
               OpName %p "p"
               OpName %ph "ph"
               OpName %tangent "tangent"
               OpName %bitangent "bitangent"
               OpName %pos_0 "pos"
               OpName %block "block"
               OpName %blocks "blocks"
               OpName %block_x "block_x"
               OpName %block_y "block_y"
               OpName %block_pos_0 "block_pos"
               OpName %relative_voxel_pos_0 "relative_voxel_pos"
               OpName %block_id_0 "block_id"
               OpName %param_3 "param"
               OpName %voxel_pos "voxel_pos"
               OpName %param_4 "param"
               OpName %param_5 "param"
               OpName %voxel_0 "voxel"
               OpName %blockPalette "blockPalette"
               OpName %mat "mat"
               OpName %voxelPalette "voxelPalette"
               OpName %effective_origin "effective_origin"
               OpName %block_corner1 "block_corner1"
               OpName %block_corner2 "block_corner2"
               OpName %block_hit "block_hit"
               OpName %steps "steps"
               OpName %fsteps "fsteps"
               OpName %tMax_0 "tMax"
               OpName %tDelta_0 "tDelta"
               OpName %voxel_pos_0 "voxel_pos"
               OpName %block_fraction "block_fraction"
               OpName %What_Is_Step "What_Is_Step"
               OpName %istep_Diretion "istep_Diretion"
               OpName %fcurrentStepDiretion "fcurrentStepDiretion"
               OpName %param_6 "param"
               OpName %param_7 "param"
               OpName %param_8 "param"
               OpName %param_9 "param"
               OpName %param_10 "param"
               OpName %current_voxel "current_voxel"
               OpName %param_11 "param"
               OpName %iterations "iterations"
               OpName %param_12 "param"
               OpName %tFinal "tFinal"
               OpName %param_13 "param"
               OpName %nIn_0 "nIn"
               OpName %nOut_0 "nOut"
               OpName %R0 "R0"
               OpName %fresnel "fresnel"
               OpName %fromOutside "fromOutside"
               OpName %ratio "ratio"
               OpName %refraction "refraction"
               OpName %reflection "reflection"
               OpName %fresnel_0 "fresnel"
               OpName %param_14 "param"
               OpName %param_15 "param"
               OpName %rand_0 "rand"
               OpName %new_origin "new_origin"
               OpName %hemisphereDistributedDirection "hemisphereDistributedDirection"
               OpName %param_16 "param"
               OpName %param_17 "param"
               OpName %new_direction "new_direction"
               OpName %refracted "refracted"
               OpName %param_18 "param"
               OpName %param_19 "param"
               OpName %param_20 "param"
               OpName %idealRefraction "idealRefraction"
               OpName %param_21 "param"
               OpName %param_22 "param"
               OpName %param_23 "param"
               OpName %param_24 "param"
               OpName %idealReflection "idealReflection"
               OpName %fraction_2 "fraction"
               OpName %normal_5 "normal"
               OpName %i "i"
               OpName %hit "hit"
               OpName %material_2 "material"
               OpName %param_25 "param"
               OpName %param_26 "param"
               OpName %param_27 "param"
               OpName %param_28 "param"
               OpName %param_29 "param"
               OpName %param_30 "param"
               OpName %param_31 "param"
               OpName %param_32 "param"
               OpName %param_33 "param"
               OpName %param_34 "param"
               OpName %param_35 "param"
               OpName %param_36 "param"
               OpName %param_37 "param"
               OpName %global_light_participance "global_light_participance"
               OpName %posMat "posMat"
               OpName %norms "norms"
               OpName %depth_0 "depth"
               OpName %param_38 "param"
               OpName %diff "diff"
               OpName %ssr "ssr"
               OpName %counter "counter"
               OpName %smooth_intersection_0 "smooth_intersection"
               OpName %fraction_step "fraction_step"
               OpName %pix_0 "pix"
               OpName %depth_1 "depth"
               OpName %new_origin_0 "new_origin"
               OpName %relative_pos "relative_pos"
               OpName %param_39 "param"
               OpName %param_40 "param"
               OpName %param_41 "param"
               OpName %param_42 "param"
               OpName %param_43 "param"
               OpName %pix_1 "pix"
               OpName %gl_GlobalInvocationID "gl_GlobalInvocationID"
               OpName %size "size"
               OpName %frame "frame"
               OpName %pos_1 "pos"
               OpName %constants "constants"
               OpMemberName %constants 0 "timeSeed"
               OpName %PushConstants "PushConstants"
               OpName %depth_2 "depth"
               OpName %fmat "fmat"
               OpName %material_3 "material"
               OpName %param_44 "param"
               OpName %direction_3 "direction"
               OpName %normal_6 "normal"
               OpName %param_45 "param"
               OpName %origin_1 "origin"
               OpName %param_46 "param"
               OpName %param_47 "param"
               OpName %accumulated_light_1 "accumulated_light"
               OpName %accumulated_reflection_1 "accumulated_reflection"
               OpName %fvoxel "fvoxel"
               OpName %param_48 "param"
               OpName %ssr_0 "ssr"
               OpName %i_0 "i"
               OpName %fraction_3 "fraction"
               OpName %param_49 "param"
               OpName %param_50 "param"
               OpName %param_51 "param"
               OpName %param_52 "param"
               OpName %param_53 "param"
               OpName %param_54 "param"
               OpName %param_55 "param"
               OpName %param_56 "param"
               OpName %param_57 "param"
               OpName %param_58 "param"
               OpName %param_59 "param"
               OpName %param_60 "param"
               OpName %param_61 "param"
               OpName %color "color"
               OpName %samplei "samplei"
               OpName %param_62 "param"
               OpName %param_63 "param"
               OpName %param_64 "param"
               OpName %param_65 "param"
               OpName %param_66 "param"
               OpName %old_clip "old_clip"
               OpName %diffs "diffs"
               OpName %old_uv "old_uv"
               OpName %old_color "old_color"
               OpName %frame_sampler "frame_sampler"
               OpDecorate %blocks DescriptorSet 0
               OpDecorate %blocks Binding 3
               OpDecorate %blockPalette DescriptorSet 0
               OpDecorate %blockPalette Binding 4
               OpDecorate %voxelPalette DescriptorSet 0
               OpDecorate %voxelPalette Binding 5
               OpDecorate %voxelPalette NonWritable
               OpDecorate %What_Is_Step RelaxedPrecision
               OpDecorate %posMat DescriptorSet 0
               OpDecorate %posMat Binding 0
               OpDecorate %posMat NonWritable
               OpDecorate %norms DescriptorSet 0
               OpDecorate %norms Binding 1
               OpDecorate %norms NonWritable
               OpDecorate %gl_GlobalInvocationID BuiltIn GlobalInvocationId
               OpDecorate %frame DescriptorSet 0
               OpDecorate %frame Binding 6
               OpMemberDecorate %constants 0 Offset 0
               OpDecorate %constants Block
               OpDecorate %diffs DescriptorSet 0
               OpDecorate %diffs Binding 2
               OpDecorate %diffs NonWritable
               OpDecorate %frame_sampler DescriptorSet 0
               OpDecorate %frame_sampler Binding 7
               OpDecorate %gl_WorkGroupSize BuiltIn WorkgroupSize
       %void = OpTypeVoid
          %4 = OpTypeFunction %void
       %uint = OpTypeInt 32 0
%_ptr_Function_uint = OpTypePointer Function %uint
          %9 = OpTypeFunction %uint %_ptr_Function_uint %_ptr_Function_uint %_ptr_Function_uint
      %float = OpTypeFloat 32
         %16 = OpTypeFunction %float
     %v3uint = OpTypeVector %uint 3
%_ptr_Function_v3uint = OpTypePointer Function %v3uint
         %23 = OpTypeFunction %v3uint %_ptr_Function_v3uint
    %v3float = OpTypeVector %float 3
         %28 = OpTypeFunction %v3float
%_ptr_Function_v3float = OpTypePointer Function %v3float
         %32 = OpTypeFunction %v3float %_ptr_Function_v3float %_ptr_Function_v3float
%_ptr_Function_float = OpTypePointer Function %float
    %v2float = OpTypeVector %float 2
%_ptr_Function_v2float = OpTypePointer Function %v2float
         %40 = OpTypeFunction %v3float %_ptr_Function_float %_ptr_Function_v2float
        %int = OpTypeInt 32 1
      %v3int = OpTypeVector %int 3
%_ptr_Function_v3int = OpTypePointer Function %v3int
         %48 = OpTypeFunction %int %_ptr_Function_v3int
%_ptr_Function_int = OpTypePointer Function %int
         %53 = OpTypeFunction %v3int %_ptr_Function_v3int %_ptr_Function_int
   %Material = OpTypeStruct %v3float %float %float %float
         %62 = OpTypeFunction %Material %_ptr_Function_int
       %bool = OpTypeBool
         %67 = OpTypeFunction %bool %_ptr_Function_v3float %_ptr_Function_v3float %_ptr_Function_v3int %_ptr_Function_v3float %_ptr_Function_v3float
%_ptr_Function_Material = OpTypePointer Function %Material
         %76 = OpTypeFunction %bool %_ptr_Function_v3float %_ptr_Function_v3float %_ptr_Function_float %_ptr_Function_v3float %_ptr_Function_Material %_ptr_Function_float
         %85 = OpTypeFunction %float %_ptr_Function_v3float %_ptr_Function_v3float
         %90 = OpTypeFunction %v3float %_ptr_Function_v3float %_ptr_Function_v3float %_ptr_Function_float %_ptr_Function_float
         %97 = OpTypeFunction %bool %_ptr_Function_v3float %_ptr_Function_v3float %_ptr_Function_float
        %103 = OpTypeFunction %void %_ptr_Function_v3float %_ptr_Function_v3float %_ptr_Function_float %_ptr_Function_v3float %_ptr_Function_Material %_ptr_Function_v3float %_ptr_Function_v3float
        %113 = OpTypeFunction %v3float %_ptr_Function_v3float %_ptr_Function_v3float %_ptr_Function_v3float %_ptr_Function_v3float %_ptr_Function_float
      %v2int = OpTypeVector %int 2
%_ptr_Function_v2int = OpTypePointer Function %v2int
        %123 = OpTypeFunction %float %_ptr_Function_v2int
        %127 = OpTypeFunction %v3float %_ptr_Function_v2int
%_ptr_Function_bool = OpTypePointer Function %bool
        %132 = OpTypeFunction %bool %_ptr_Function_float %_ptr_Function_v2float %_ptr_Function_bool
        %138 = OpTypeFunction %bool %_ptr_Function_v3float %_ptr_Function_v3float %_ptr_Function_v2float %_ptr_Function_float %_ptr_Function_v3float %_ptr_Function_Material
     %int_11 = OpConstant %int 11
      %int_7 = OpConstant %int 7
      %int_3 = OpConstant %int 3
     %int_14 = OpConstant %int 14
      %int_6 = OpConstant %int 6
     %int_15 = OpConstant %int 15
      %int_5 = OpConstant %int 5
     %int_12 = OpConstant %int 12
      %int_9 = OpConstant %int 9
%uint_8388607 = OpConstant %uint 8388607
%uint_1065353216 = OpConstant %uint 1065353216
%_ptr_Private_v3float = OpTypePointer Private %v3float
    %randvec = OpVariable %_ptr_Private_v3float Private
     %uint_0 = OpConstant %uint 0
     %uint_1 = OpConstant %uint 1
     %uint_2 = OpConstant %uint 2
    %float_1 = OpConstant %float 1
%_ptr_Private_float = OpTypePointer Private %float
%uint_1664525 = OpConstant %uint 1664525
%uint_1013904223 = OpConstant %uint 1013904223
    %uint_16 = OpConstant %uint 16
  %float_0_5 = OpConstant %float 0.5
%float_3_14159274 = OpConstant %float 3.14159274
    %float_0 = OpConstant %float 0
        %400 = OpConstantComposite %v3float %float_0 %float_0 %float_0
   %float_60 = OpConstant %float 60
   %float_50 = OpConstant %float 50
        %403 = OpConstantComposite %v3float %float_60 %float_0 %float_50
%float_0_995037198 = OpConstant %float 0.995037198
%float_n0_0995037183 = OpConstant %float -0.0995037183
        %406 = OpConstantComposite %v3float %float_0_995037198 %float_n0_0995037183 %float_0
%float_45_7142868 = OpConstant %float 45.7142868
%float_n0_0443224795 = OpConstant %float -0.0443224795
%float_n0_443224788 = OpConstant %float -0.443224788
%float_n0_895314097 = OpConstant %float -0.895314097
        %416 = OpConstantComposite %v3float %float_n0_0443224795 %float_n0_443224788 %float_n0_895314097
%float_25_7142849 = OpConstant %float 25.7142849
%float_0_0890870839 = OpConstant %float 0.0890870839
%float_0_89087081 = OpConstant %float 0.89087081
%float_n0_445435405 = OpConstant %float -0.445435405
        %427 = OpConstantComposite %v3float %float_0_0890870839 %float_0_89087081 %float_n0_445435405
        %434 = OpTypeImage %int 3D 0 0 0 2 R32i
%_ptr_UniformConstant_434 = OpTypePointer UniformConstant %434
     %blocks = OpVariable %_ptr_UniformConstant_434 UniformConstant
      %v4int = OpTypeVector %int 4
     %int_32 = OpConstant %int 32
     %int_16 = OpConstant %int 16
      %int_0 = OpConstant %int 0
        %482 = OpTypeImage %uint 3D 0 0 0 2 R8ui
%_ptr_UniformConstant_482 = OpTypePointer UniformConstant %482
%blockPalette = OpVariable %_ptr_UniformConstant_482 UniformConstant
     %v4uint = OpTypeVector %uint 4
        %495 = OpTypeImage %float 2D 0 0 0 2 R32f
%_ptr_UniformConstant_495 = OpTypePointer UniformConstant %495
%voxelPalette = OpVariable %_ptr_UniformConstant_495 UniformConstant
    %v4float = OpTypeVector %float 4
      %int_1 = OpConstant %int 1
      %int_2 = OpConstant %int 2
      %int_4 = OpConstant %int 4
        %551 = OpConstantComposite %v3float %float_1 %float_1 %float_1
       %true = OpConstantTrue %bool
      %false = OpConstantFalse %bool
        %621 = OpConstantComposite %v3int %int_0 %int_0 %int_0
     %v3bool = OpTypeVector %bool 3
    %int_128 = OpConstant %int 128
        %722 = OpConstantComposite %v3int %int_128 %int_128 %int_128
    %int_100 = OpConstant %int 100
    %float_5 = OpConstant %float 5
%float_n0_00100000005 = OpConstant %float -0.00100000005
%float_0_00100000005 = OpConstant %float 0.00100000005
  %float_999 = OpConstant %float 999
%float_0_00999999978 = OpConstant %float 0.00999999978
%float_1_73205078 = OpConstant %float 1.73205078
%float_0_408248305 = OpConstant %float 0.408248305
%float_0_816496611 = OpConstant %float 0.816496611
%float_n0_408248305 = OpConstant %float -0.408248305
       %1011 = OpConstantComposite %v3float %float_0_408248305 %float_0_816496611 %float_n0_408248305
%float_0_449999988 = OpConstant %float 0.449999988
%float_0_300000012 = OpConstant %float 0.300000012
       %1020 = OpConstantComposite %v3float %float_0_449999988 %float_0_449999988 %float_0_300000012
       %1030 = OpTypeImage %float 2D 0 0 0 2 Rgba32f
%_ptr_UniformConstant_1030 = OpTypePointer UniformConstant %1030
     %posMat = OpVariable %_ptr_UniformConstant_1030 UniformConstant
      %norms = OpVariable %_ptr_UniformConstant_1030 UniformConstant
%float_0_100000001 = OpConstant %float 0.100000001
    %float_2 = OpConstant %float 2
     %uint_3 = OpConstant %uint 3
%_ptr_Input_v3uint = OpTypePointer Input %v3uint
%gl_GlobalInvocationID = OpVariable %_ptr_Input_v3uint Input
     %v2uint = OpTypeVector %uint 2
       %1168 = OpTypeImage %float 2D 0 0 0 2 Rgba8
%_ptr_UniformConstant_1168 = OpTypePointer UniformConstant %1168
      %frame = OpVariable %_ptr_UniformConstant_1168 UniformConstant
   %int_1920 = OpConstant %int 1920
   %int_1061 = OpConstant %int 1061
       %1175 = OpConstantComposite %v2int %int_1920 %int_1061
  %constants = OpTypeStruct %int
%_ptr_PushConstant_constants = OpTypePointer PushConstant %constants
%PushConstants = OpVariable %_ptr_PushConstant_constants PushConstant
%_ptr_PushConstant_int = OpTypePointer PushConstant %int
      %diffs = OpVariable %_ptr_UniformConstant_1030 UniformConstant
       %1364 = OpTypeImage %float 2D 0 0 0 1 Unknown
       %1365 = OpTypeSampledImage %1364
%_ptr_UniformConstant_1365 = OpTypePointer UniformConstant %1365
%frame_sampler = OpVariable %_ptr_UniformConstant_1365 UniformConstant
%float_0_899999976 = OpConstant %float 0.899999976
%float_0_0995037183 = OpConstant %float 0.0995037183
       %1385 = OpConstantComposite %v3float %float_0_0995037183 %float_0_995037198 %float_0
     %uint_8 = OpConstant %uint 8
%gl_WorkGroupSize = OpConstantComposite %v3uint %uint_8 %uint_8 %uint_1
               OpLine %1 690 15
       %main = OpFunction %void None %4
          %6 = OpLabel
      %pix_1 = OpVariable %_ptr_Function_v2int Function
       %size = OpVariable %_ptr_Function_v2int Function
      %pos_1 = OpVariable %_ptr_Function_v2float Function
    %depth_2 = OpVariable %_ptr_Function_float Function
       %fmat = OpVariable %_ptr_Function_float Function
 %material_3 = OpVariable %_ptr_Function_Material Function
   %param_44 = OpVariable %_ptr_Function_int Function
%direction_3 = OpVariable %_ptr_Function_v3float Function
   %normal_6 = OpVariable %_ptr_Function_v3float Function
   %param_45 = OpVariable %_ptr_Function_v2int Function
   %origin_1 = OpVariable %_ptr_Function_v3float Function
   %param_46 = OpVariable %_ptr_Function_float Function
   %param_47 = OpVariable %_ptr_Function_v2float Function
%accumulated_light_1 = OpVariable %_ptr_Function_v3float Function
%accumulated_reflection_1 = OpVariable %_ptr_Function_v3float Function
     %fvoxel = OpVariable %_ptr_Function_float Function
   %param_48 = OpVariable %_ptr_Function_v3int Function
      %ssr_0 = OpVariable %_ptr_Function_bool Function
        %i_0 = OpVariable %_ptr_Function_int Function
 %fraction_3 = OpVariable %_ptr_Function_float Function
   %param_49 = OpVariable %_ptr_Function_v3float Function
   %param_50 = OpVariable %_ptr_Function_v3float Function
   %param_51 = OpVariable %_ptr_Function_v2float Function
   %param_52 = OpVariable %_ptr_Function_float Function
   %param_53 = OpVariable %_ptr_Function_v3float Function
   %param_54 = OpVariable %_ptr_Function_Material Function
   %param_55 = OpVariable %_ptr_Function_v3float Function
   %param_56 = OpVariable %_ptr_Function_v3float Function
   %param_57 = OpVariable %_ptr_Function_float Function
   %param_58 = OpVariable %_ptr_Function_v3float Function
   %param_59 = OpVariable %_ptr_Function_Material Function
   %param_60 = OpVariable %_ptr_Function_v3float Function
   %param_61 = OpVariable %_ptr_Function_v3float Function
      %color = OpVariable %_ptr_Function_v3float Function
    %samplei = OpVariable %_ptr_Function_int Function
   %param_62 = OpVariable %_ptr_Function_v3float Function
   %param_63 = OpVariable %_ptr_Function_v3float Function
   %param_64 = OpVariable %_ptr_Function_v3float Function
   %param_65 = OpVariable %_ptr_Function_v3float Function
   %param_66 = OpVariable %_ptr_Function_float Function
   %old_clip = OpVariable %_ptr_Function_v2float Function
     %old_uv = OpVariable %_ptr_Function_v2float Function
  %old_color = OpVariable %_ptr_Function_v3float Function
               OpLine %1 691 0
       %1164 = OpLoad %v3uint %gl_GlobalInvocationID
       %1165 = OpVectorShuffle %v2uint %1164 %1164 0 1
       %1166 = OpBitcast %v2int %1165
               OpStore %pix_1 %1166
               OpLine %1 694 0
       %1171 = OpLoad %1168 %frame
       %1172 = OpImageQuerySize %v2int %1171
               OpStore %size %1172
               OpLine %1 695 0
               OpStore %size %1175
               OpLine %1 696 0
       %1176 = OpAccessChain %_ptr_Function_int %pix_1 %uint_0
       %1177 = OpLoad %int %1176
       %1178 = OpAccessChain %_ptr_Function_int %size %uint_0
       %1179 = OpLoad %int %1178
       %1180 = OpSGreaterThanEqual %bool %1177 %1179
       %1181 = OpLogicalNot %bool %1180
               OpSelectionMerge %1183 None
               OpBranchConditional %1181 %1182 %1183
       %1182 = OpLabel
               OpLine %1 696 0
       %1184 = OpAccessChain %_ptr_Function_int %pix_1 %uint_1
       %1185 = OpLoad %int %1184
       %1186 = OpAccessChain %_ptr_Function_int %size %uint_1
       %1187 = OpLoad %int %1186
       %1188 = OpSGreaterThanEqual %bool %1185 %1187
               OpBranch %1183
       %1183 = OpLabel
       %1189 = OpPhi %bool %1180 %6 %1188 %1182
               OpSelectionMerge %1191 None
               OpBranchConditional %1189 %1190 %1191
       %1190 = OpLabel
               OpLine %1 697 0
               OpReturn
       %1191 = OpLabel
               OpLine %1 700 0
       %1194 = OpLoad %v2int %pix_1
       %1195 = OpConvertSToF %v2float %1194
       %1196 = OpAccessChain %_ptr_Function_int %size %uint_0
       %1197 = OpLoad %int %1196
       %1198 = OpISub %int %1197 %int_1
       %1199 = OpConvertSToF %float %1198
       %1200 = OpAccessChain %_ptr_Function_int %size %uint_1
       %1201 = OpLoad %int %1200
       %1202 = OpISub %int %1201 %int_1
       %1203 = OpConvertSToF %float %1202
       %1204 = OpCompositeConstruct %v2float %1199 %1203
       %1205 = OpFDiv %v2float %1195 %1204
               OpStore %pos_1 %1205
               OpLine %1 701 0
       %1206 = OpAccessChain %_ptr_Function_float %pos_1 %uint_1
       %1207 = OpLoad %float %1206
       %1208 = OpAccessChain %_ptr_Function_float %pos_1 %uint_0
       %1209 = OpLoad %float %1208
       %1210 = OpAccessChain %_ptr_Function_float %pos_1 %uint_0
       %1211 = OpLoad %float %1210
       %1212 = OpAccessChain %_ptr_Function_float %pos_1 %uint_1
       %1213 = OpLoad %float %1212
       %1214 = OpFMul %float %1211 %1213
       %1215 = OpCompositeConstruct %v3float %1207 %1209 %1214
       %1220 = OpAccessChain %_ptr_PushConstant_int %PushConstants %int_0
       %1221 = OpLoad %int %1220
       %1222 = OpConvertSToF %float %1221
       %1223 = OpExtInst %float %2 Sin %1222
       %1224 = OpFAdd %float %float_0_100000001 %1223
       %1225 = OpVectorTimesScalar %v3float %1215 %1224
               OpStore %randvec %1225
               OpLine %1 709 0
       %1227 = OpLoad %1030 %posMat
       %1228 = OpLoad %v2int %pix_1
       %1229 = OpImageRead %v4float %1227 %1228
       %1230 = OpCompositeExtract %float %1229 0
               OpStore %depth_2 %1230
               OpLine %1 710 0
       %1232 = OpLoad %1030 %posMat
       %1233 = OpLoad %v2int %pix_1
       %1234 = OpImageRead %v4float %1232 %1233
       %1235 = OpCompositeExtract %float %1234 3
               OpStore %fmat %1235
               OpLine %1 711 0
       %1237 = OpLoad %float %fmat
       %1238 = OpConvertFToS %int %1237
               OpStore %param_44 %1238
       %1240 = OpFunctionCall %Material %GetMat_i1_ %param_44
               OpStore %material_3 %1240
               OpLine %1 713 0
               OpStore %direction_3 %427
               OpLine %1 714 0
       %1244 = OpLoad %v2int %pix_1
               OpStore %param_45 %1244
       %1245 = OpFunctionCall %v3float %load_norm_vi2_ %param_45
               OpStore %normal_6 %1245
               OpLine %1 715 0
       %1247 = OpAccessChain %_ptr_Function_float %pos_1 %uint_0
       %1248 = OpLoad %float %1247
       %1249 = OpFSub %float %1248 %float_0_5
       %1250 = OpAccessChain %_ptr_Function_float %pos_1 %uint_1
       %1251 = OpLoad %float %1250
       %1252 = OpFSub %float %1251 %float_0_5
       %1253 = OpCompositeConstruct %v2float %1249 %1252
       %1254 = OpVectorTimesScalar %v2float %1253 %float_2
       %1256 = OpLoad %float %depth_2
               OpStore %param_46 %1256
               OpStore %param_47 %1254
       %1258 = OpFunctionCall %v3float %get_origin_from_depth_f1_vf2_ %param_46 %param_47
               OpStore %origin_1 %1258
               OpLine %1 717 0
               OpStore %accumulated_light_1 %400
               OpLine %1 718 0
               OpStore %accumulated_reflection_1 %551
               OpLine %1 726 0
       %1262 = OpLoad %v3float %origin_1
       %1263 = OpLoad %v3float %direction_3
       %1264 = OpFAdd %v3float %1262 %1263
       %1265 = OpConvertFToS %v3int %1264
               OpStore %param_48 %1265
       %1267 = OpFunctionCall %int %GetVoxel_vi3_ %param_48
       %1268 = OpConvertSToF %float %1267
               OpStore %fvoxel %1268
               OpLine %1 727 0
               OpStore %fvoxel %float_999
               OpLine %1 746 0
               OpStore %ssr_0 %true
               OpLine %1 748 0
               OpStore %i_0 %int_0
               OpBranch %1271
       %1271 = OpLabel
               OpLine %1 748 0
               OpLoopMerge %1273 %1274 None
               OpBranch %1275
       %1275 = OpLabel
               OpLine %1 748 0
       %1276 = OpLoad %int %i_0
       %1277 = OpSLessThan %bool %1276 %int_2
               OpBranchConditional %1277 %1272 %1273
       %1272 = OpLabel
               OpLine %1 749 0
       %1278 = OpLoad %int %i_0
       %1279 = OpIEqual %bool %1278 %int_1
               OpSelectionMerge %1281 None
               OpBranchConditional %1279 %1280 %1281
       %1280 = OpLabel
               OpLine %1 750 0
               OpStore %fraction_3 %float_0
               OpLine %1 751 0
       %1283 = OpLoad %v2int %pix_1
       %1284 = OpConvertSToF %v2float %1283
       %1286 = OpLoad %v3float %origin_1
               OpStore %param_49 %1286
       %1288 = OpLoad %v3float %direction_3
               OpStore %param_50 %1288
               OpStore %param_51 %1284
       %1293 = OpFunctionCall %bool %ssr_traceRay_vf3_vf3_vf2_f1_vf3_struct_Material_vf3_f1_f1_f11_ %param_49 %param_50 %param_51 %param_52 %param_53 %param_54
       %1294 = OpLoad %float %param_52
               OpStore %fraction_3 %1294
       %1295 = OpLoad %v3float %param_53
               OpStore %normal_6 %1295
       %1296 = OpLoad %Material %param_54
               OpStore %material_3 %1296
               OpStore %ssr_0 %1293
               OpLine %1 752 0
       %1297 = OpLoad %v3float %direction_3
       %1298 = OpLoad %float %fraction_3
       %1299 = OpVectorTimesScalar %v3float %1297 %1298
       %1300 = OpLoad %v3float %origin_1
       %1301 = OpFAdd %v3float %1300 %1299
               OpStore %origin_1 %1301
               OpBranch %1281
       %1281 = OpLabel
               OpLine %1 760 0
       %1302 = OpLoad %bool %ssr_0
               OpSelectionMerge %1304 None
               OpBranchConditional %1302 %1303 %1304
       %1303 = OpLabel
               OpLine %1 763 0
               OpLine %1 761 0
               OpLine %1 762 0
               OpLine %1 763 0
       %1306 = OpLoad %v3float %origin_1
               OpStore %param_55 %1306
       %1308 = OpLoad %v3float %direction_3
               OpStore %param_56 %1308
               OpStore %param_57 %float_0
       %1311 = OpLoad %v3float %normal_6
               OpStore %param_58 %1311
       %1313 = OpLoad %Material %material_3
               OpStore %param_59 %1313
       %1315 = OpLoad %v3float %accumulated_light_1
               OpStore %param_60 %1315
       %1317 = OpLoad %v3float %accumulated_reflection_1
               OpStore %param_61 %1317
       %1318 = OpFunctionCall %void %ProcessHit_vf3_vf3_f1_vf3_struct_Material_vf3_f1_f1_f11_vf3_vf3_ %param_55 %param_56 %param_57 %param_58 %param_59 %param_60 %param_61
       %1319 = OpLoad %v3float %param_55
               OpStore %origin_1 %1319
       %1320 = OpLoad %v3float %param_56
               OpStore %direction_3 %1320
       %1321 = OpLoad %v3float %param_60
               OpStore %accumulated_light_1 %1321
       %1322 = OpLoad %v3float %param_61
               OpStore %accumulated_reflection_1 %1322
               OpBranch %1304
       %1304 = OpLabel
               OpBranch %1274
       %1274 = OpLabel
               OpLine %1 748 0
       %1323 = OpLoad %int %i_0
       %1324 = OpIAdd %int %1323 %int_1
               OpStore %i_0 %1324
               OpBranch %1271
       %1273 = OpLabel
               OpLine %1 782 0
               OpStore %color %400
               OpLine %1 783 0
               OpStore %samplei %int_0
               OpBranch %1327
       %1327 = OpLabel
               OpLine %1 783 0
               OpLoopMerge %1329 %1330 None
               OpBranch %1331
       %1331 = OpLabel
               OpLine %1 783 0
       %1332 = OpLoad %int %samplei
       %1333 = OpSLessThan %bool %1332 %int_1
               OpBranchConditional %1333 %1328 %1329
       %1328 = OpLabel
               OpLine %1 785 0
       %1335 = OpLoad %v3float %origin_1
               OpStore %param_62 %1335
       %1337 = OpLoad %v3float %direction_3
               OpStore %param_63 %1337
       %1339 = OpLoad %v3float %accumulated_light_1
               OpStore %param_64 %1339
       %1341 = OpLoad %v3float %accumulated_reflection_1
               OpStore %param_65 %1341
       %1343 = OpLoad %float %fvoxel
               OpStore %param_66 %1343
       %1344 = OpFunctionCall %v3float %TraceRay_vf3_vf3_vf3_vf3_f1_ %param_62 %param_63 %param_64 %param_65 %param_66
       %1345 = OpCompositeConstruct %v3float %float_1 %float_1 %float_1
       %1346 = OpFDiv %v3float %1344 %1345
       %1347 = OpLoad %v3float %color
       %1348 = OpFAdd %v3float %1347 %1346
               OpStore %color %1348
               OpBranch %1330
       %1330 = OpLabel
               OpLine %1 783 0
       %1349 = OpLoad %int %samplei
       %1350 = OpIAdd %int %1349 %int_1
               OpStore %samplei %1350
               OpBranch %1327
       %1329 = OpLabel
               OpLine %1 788 0
       %1353 = OpLoad %1030 %diffs
       %1354 = OpLoad %v2int %pix_1
       %1355 = OpImageRead %v4float %1353 %1354
       %1356 = OpVectorShuffle %v2float %1355 %1355 0 1
               OpStore %old_clip %1356
               OpLine %1 789 0
       %1358 = OpLoad %v2float %old_clip
       %1359 = OpCompositeConstruct %v2float %float_2 %float_2
       %1360 = OpFDiv %v2float %1358 %1359
       %1361 = OpCompositeConstruct %v2float %float_0_5 %float_0_5
       %1362 = OpFAdd %v2float %1360 %1361
               OpStore %old_uv %1362
               OpLine %1 792 0
       %1368 = OpLoad %1365 %frame_sampler
       %1369 = OpLoad %v2float %old_uv
       %1370 = OpImageSampleExplicitLod %v4float %1368 %1369 Lod %float_0
       %1371 = OpVectorShuffle %v3float %1370 %1370 0 1 2
               OpStore %old_color %1371
               OpLine %1 793 0
       %1372 = OpLoad %v3float %color
       %1373 = OpLoad %v3float %old_color
       %1375 = OpCompositeConstruct %v3float %float_0_899999976 %float_0_899999976 %float_0_899999976
       %1376 = OpExtInst %v3float %2 FMix %1372 %1373 %1375
               OpStore %color %1376
               OpLine %1 794 0
       %1377 = OpLoad %1168 %frame
       %1378 = OpLoad %v2int %pix_1
       %1379 = OpLoad %v3float %color
       %1380 = OpCompositeExtract %float %1379 0
       %1381 = OpCompositeExtract %float %1379 1
       %1382 = OpCompositeExtract %float %1379 2
       %1383 = OpCompositeConstruct %v4float %1380 %1381 %1382 %float_1
               OpImageWrite %1377 %1378 %1383
               OpReturn
               OpFunctionEnd
               OpLine %1 58 34
%hash3_u1_u1_u1_ = OpFunction %uint None %9
          %x = OpFunctionParameter %_ptr_Function_uint
          %y = OpFunctionParameter %_ptr_Function_uint
          %z = OpFunctionParameter %_ptr_Function_uint
         %14 = OpLabel
               OpLine %1 59 0
        %147 = OpLoad %uint %x
        %149 = OpShiftRightLogical %uint %147 %int_11
        %150 = OpLoad %uint %x
        %151 = OpIAdd %uint %150 %149
               OpStore %x %151
               OpLine %1 60 0
        %152 = OpLoad %uint %x
        %154 = OpShiftLeftLogical %uint %152 %int_7
        %155 = OpLoad %uint %x
        %156 = OpBitwiseXor %uint %155 %154
               OpStore %x %156
               OpLine %1 61 0
        %157 = OpLoad %uint %y
        %158 = OpLoad %uint %x
        %159 = OpIAdd %uint %158 %157
               OpStore %x %159
               OpLine %1 62 0
        %160 = OpLoad %uint %x
        %162 = OpShiftLeftLogical %uint %160 %int_3
        %163 = OpLoad %uint %x
        %164 = OpBitwiseXor %uint %163 %162
               OpStore %x %164
               OpLine %1 63 0
        %165 = OpLoad %uint %z
        %166 = OpLoad %uint %x
        %168 = OpShiftRightLogical %uint %166 %int_14
        %169 = OpBitwiseXor %uint %165 %168
        %170 = OpLoad %uint %x
        %171 = OpIAdd %uint %170 %169
               OpStore %x %171
               OpLine %1 64 0
        %172 = OpLoad %uint %x
        %174 = OpShiftLeftLogical %uint %172 %int_6
        %175 = OpLoad %uint %x
        %176 = OpBitwiseXor %uint %175 %174
               OpStore %x %176
               OpLine %1 65 0
        %177 = OpLoad %uint %x
        %179 = OpShiftRightLogical %uint %177 %int_15
        %180 = OpLoad %uint %x
        %181 = OpIAdd %uint %180 %179
               OpStore %x %181
               OpLine %1 66 0
        %182 = OpLoad %uint %x
        %184 = OpShiftLeftLogical %uint %182 %int_5
        %185 = OpLoad %uint %x
        %186 = OpBitwiseXor %uint %185 %184
               OpStore %x %186
               OpLine %1 67 0
        %187 = OpLoad %uint %x
        %189 = OpShiftRightLogical %uint %187 %int_12
        %190 = OpLoad %uint %x
        %191 = OpIAdd %uint %190 %189
               OpStore %x %191
               OpLine %1 68 0
        %192 = OpLoad %uint %x
        %194 = OpShiftLeftLogical %uint %192 %int_9
        %195 = OpLoad %uint %x
        %196 = OpBitwiseXor %uint %195 %194
               OpStore %x %196
               OpLine %1 69 0
        %197 = OpLoad %uint %x
               OpReturnValue %197
               OpFunctionEnd
               OpLine %1 80 19
%RandomNoise_ = OpFunction %float None %16
         %18 = OpLabel
%mantissaMask = OpVariable %_ptr_Function_uint Function
        %one = OpVariable %_ptr_Function_uint Function
          %u = OpVariable %_ptr_Function_v3uint Function
          %h = OpVariable %_ptr_Function_uint Function
      %param = OpVariable %_ptr_Function_uint Function
    %param_0 = OpVariable %_ptr_Function_uint Function
    %param_1 = OpVariable %_ptr_Function_uint Function
        %res = OpVariable %_ptr_Function_float Function
               OpLine %1 81 0
               OpStore %mantissaMask %uint_8388607
               OpLine %1 82 0
               OpStore %one %uint_1065353216
               OpLine %1 83 0
        %207 = OpLoad %v3float %randvec
        %208 = OpBitcast %v3uint %207
               OpStore %u %208
               OpLine %1 84 0
        %212 = OpAccessChain %_ptr_Function_uint %u %uint_0
        %213 = OpLoad %uint %212
               OpStore %param %213
        %216 = OpAccessChain %_ptr_Function_uint %u %uint_1
        %217 = OpLoad %uint %216
               OpStore %param_0 %217
        %220 = OpAccessChain %_ptr_Function_uint %u %uint_2
        %221 = OpLoad %uint %220
               OpStore %param_1 %221
        %222 = OpFunctionCall %uint %hash3_u1_u1_u1_ %param %param_0 %param_1
               OpStore %h %222
               OpLine %1 85 0
        %224 = OpLoad %uint %h
        %225 = OpLoad %uint %mantissaMask
        %226 = OpBitwiseAnd %uint %224 %225
        %227 = OpLoad %uint %one
        %228 = OpBitwiseOr %uint %226 %227
        %229 = OpBitcast %float %228
        %231 = OpFSub %float %229 %float_1
               OpStore %res %231
               OpLine %1 87 0
        %233 = OpAccessChain %_ptr_Private_float %randvec %uint_1
        %234 = OpLoad %float %233
        %235 = OpExtInst %float %2 Sin %234
        %236 = OpAccessChain %_ptr_Private_float %randvec %uint_0
               OpStore %236 %235
               OpLine %1 88 0
        %237 = OpAccessChain %_ptr_Private_float %randvec %uint_2
        %238 = OpLoad %float %237
        %239 = OpExtInst %float %2 Sin %238
        %240 = OpAccessChain %_ptr_Private_float %randvec %uint_1
               OpStore %240 %239
               OpLine %1 89 0
        %241 = OpLoad %float %res
        %242 = OpExtInst %float %2 Sin %241
        %243 = OpAccessChain %_ptr_Private_float %randvec %uint_2
               OpStore %243 %242
               OpLine %1 91 0
        %244 = OpLoad %float %res
        %245 = OpExtInst %float %2 Sin %244
               OpReturnValue %245
               OpFunctionEnd
               OpLine %1 94 24
%RandomFloat_0to1_ = OpFunction %float None %16
         %20 = OpLabel
               OpLine %1 95 0
        %248 = OpFunctionCall %float %RandomNoise_
               OpReturnValue %248
               OpFunctionEnd
               OpLine %1 102 20
 %pcg3d_vu3_ = OpFunction %v3uint None %23
          %v = OpFunctionParameter %_ptr_Function_v3uint
         %26 = OpLabel
               OpLine %1 103 0
        %251 = OpLoad %v3uint %v
        %253 = OpCompositeConstruct %v3uint %uint_1664525 %uint_1664525 %uint_1664525
        %254 = OpIMul %v3uint %251 %253
        %256 = OpCompositeConstruct %v3uint %uint_1013904223 %uint_1013904223 %uint_1013904223
        %257 = OpIAdd %v3uint %254 %256
               OpStore %v %257
               OpLine %1 104 0
        %258 = OpAccessChain %_ptr_Function_uint %v %uint_1
        %259 = OpLoad %uint %258
        %260 = OpAccessChain %_ptr_Function_uint %v %uint_2
        %261 = OpLoad %uint %260
        %262 = OpIMul %uint %259 %261
        %263 = OpAccessChain %_ptr_Function_uint %v %uint_0
        %264 = OpLoad %uint %263
        %265 = OpIAdd %uint %264 %262
        %266 = OpAccessChain %_ptr_Function_uint %v %uint_0
               OpStore %266 %265
               OpLine %1 105 0
        %267 = OpAccessChain %_ptr_Function_uint %v %uint_2
        %268 = OpLoad %uint %267
        %269 = OpAccessChain %_ptr_Function_uint %v %uint_0
        %270 = OpLoad %uint %269
        %271 = OpIMul %uint %268 %270
        %272 = OpAccessChain %_ptr_Function_uint %v %uint_1
        %273 = OpLoad %uint %272
        %274 = OpIAdd %uint %273 %271
        %275 = OpAccessChain %_ptr_Function_uint %v %uint_1
               OpStore %275 %274
               OpLine %1 106 0
        %276 = OpAccessChain %_ptr_Function_uint %v %uint_0
        %277 = OpLoad %uint %276
        %278 = OpAccessChain %_ptr_Function_uint %v %uint_1
        %279 = OpLoad %uint %278
        %280 = OpIMul %uint %277 %279
        %281 = OpAccessChain %_ptr_Function_uint %v %uint_2
        %282 = OpLoad %uint %281
        %283 = OpIAdd %uint %282 %280
        %284 = OpAccessChain %_ptr_Function_uint %v %uint_2
               OpStore %284 %283
               OpLine %1 107 0
        %285 = OpLoad %v3uint %v
        %287 = OpCompositeConstruct %v3uint %uint_16 %uint_16 %uint_16
        %288 = OpShiftRightLogical %v3uint %285 %287
        %289 = OpLoad %v3uint %v
        %290 = OpBitwiseXor %v3uint %289 %288
               OpStore %v %290
               OpLine %1 108 0
        %291 = OpAccessChain %_ptr_Function_uint %v %uint_1
        %292 = OpLoad %uint %291
        %293 = OpAccessChain %_ptr_Function_uint %v %uint_2
        %294 = OpLoad %uint %293
        %295 = OpIMul %uint %292 %294
        %296 = OpAccessChain %_ptr_Function_uint %v %uint_0
        %297 = OpLoad %uint %296
        %298 = OpIAdd %uint %297 %295
        %299 = OpAccessChain %_ptr_Function_uint %v %uint_0
               OpStore %299 %298
               OpLine %1 109 0
        %300 = OpAccessChain %_ptr_Function_uint %v %uint_2
        %301 = OpLoad %uint %300
        %302 = OpAccessChain %_ptr_Function_uint %v %uint_0
        %303 = OpLoad %uint %302
        %304 = OpIMul %uint %301 %303
        %305 = OpAccessChain %_ptr_Function_uint %v %uint_1
        %306 = OpLoad %uint %305
        %307 = OpIAdd %uint %306 %304
        %308 = OpAccessChain %_ptr_Function_uint %v %uint_1
               OpStore %308 %307
               OpLine %1 110 0
        %309 = OpAccessChain %_ptr_Function_uint %v %uint_0
        %310 = OpLoad %uint %309
        %311 = OpAccessChain %_ptr_Function_uint %v %uint_1
        %312 = OpLoad %uint %311
        %313 = OpIMul %uint %310 %312
        %314 = OpAccessChain %_ptr_Function_uint %v %uint_2
        %315 = OpLoad %uint %314
        %316 = OpIAdd %uint %315 %313
        %317 = OpAccessChain %_ptr_Function_uint %v %uint_2
               OpStore %317 %316
               OpLine %1 111 0
        %318 = OpLoad %v3uint %v
               OpReturnValue %318
               OpFunctionEnd
               OpLine %1 113 15
  %Random3D_ = OpFunction %v3float None %28
         %30 = OpLabel
    %param_2 = OpVariable %_ptr_Function_v3uint Function
               OpLine %1 114 0
        %321 = OpLoad %v3float %randvec
        %322 = OpBitcast %v3uint %321
               OpStore %param_2 %322
        %324 = OpFunctionCall %v3uint %pcg3d_vu3_ %param_2
        %325 = OpCompositeConstruct %v3uint %uint_8388607 %uint_8388607 %uint_8388607
        %326 = OpBitwiseAnd %v3uint %324 %325
        %327 = OpCompositeConstruct %v3uint %uint_1065353216 %uint_1065353216 %uint_1065353216
        %328 = OpBitwiseOr %v3uint %326 %327
        %329 = OpBitcast %v3float %328
        %330 = OpCompositeConstruct %v3float %float_1 %float_1 %float_1
        %331 = OpFSub %v3float %329 %330
               OpStore %randvec %331
               OpLine %1 115 0
        %332 = OpLoad %v3float %randvec
               OpReturnValue %332
               OpFunctionEnd
               OpLine %1 134 59
%randomCosineWeightedHemispherePoint_vf3_vf3_ = OpFunction %v3float None %32
       %rand = OpFunctionParameter %_ptr_Function_v3float
          %n = OpFunctionParameter %_ptr_Function_v3float
         %36 = OpLabel
          %r = OpVariable %_ptr_Function_float Function
      %angle = OpVariable %_ptr_Function_float Function
         %sr = OpVariable %_ptr_Function_float Function
          %p = OpVariable %_ptr_Function_v2float Function
         %ph = OpVariable %_ptr_Function_v3float Function
    %tangent = OpVariable %_ptr_Function_v3float Function
  %bitangent = OpVariable %_ptr_Function_v3float Function
               OpLine %1 135 0
        %336 = OpAccessChain %_ptr_Function_float %rand %uint_0
        %337 = OpLoad %float %336
        %339 = OpFMul %float %337 %float_0_5
        %340 = OpFAdd %float %339 %float_0_5
               OpStore %r %340
               OpLine %1 136 0
        %342 = OpAccessChain %_ptr_Function_float %rand %uint_1
        %343 = OpLoad %float %342
        %344 = OpFAdd %float %343 %float_1
        %346 = OpFMul %float %344 %float_3_14159274
               OpStore %angle %346
               OpLine %1 137 0
        %348 = OpLoad %float %r
        %349 = OpExtInst %float %2 Sqrt %348
               OpStore %sr %349
               OpLine %1 138 0
        %351 = OpLoad %float %sr
        %352 = OpLoad %float %angle
        %353 = OpExtInst %float %2 Cos %352
        %354 = OpFMul %float %351 %353
        %355 = OpLoad %float %sr
        %356 = OpLoad %float %angle
        %357 = OpExtInst %float %2 Sin %356
        %358 = OpFMul %float %355 %357
        %359 = OpCompositeConstruct %v2float %354 %358
               OpStore %p %359
               OpLine %1 143 0
        %361 = OpLoad %v2float %p
        %362 = OpLoad %v2float %p
        %363 = OpLoad %v2float %p
        %364 = OpFMul %v2float %362 %363
        %365 = OpCompositeConstruct %v2float %float_1 %float_1
        %366 = OpFSub %v2float %365 %364
        %367 = OpExtInst %v2float %2 Sqrt %366
        %368 = OpCompositeExtract %float %361 0
        %369 = OpCompositeExtract %float %361 1
        %370 = OpCompositeExtract %float %367 0
        %371 = OpCompositeConstruct %v3float %368 %369 %370
               OpStore %ph %371
               OpLine %1 149 0
        %373 = OpLoad %v3float %rand
        %374 = OpExtInst %v3float %2 Normalize %373
               OpStore %tangent %374
               OpLine %1 150 0
        %376 = OpLoad %v3float %tangent
        %377 = OpLoad %v3float %n
        %378 = OpExtInst %v3float %2 Cross %376 %377
               OpStore %bitangent %378
               OpLine %1 151 0
        %379 = OpLoad %v3float %bitangent
        %380 = OpLoad %v3float %n
        %381 = OpExtInst %v3float %2 Cross %379 %380
               OpStore %tangent %381
               OpLine %1 154 0
        %382 = OpLoad %v3float %tangent
        %383 = OpAccessChain %_ptr_Function_float %ph %uint_0
        %384 = OpLoad %float %383
        %385 = OpVectorTimesScalar %v3float %382 %384
        %386 = OpLoad %v3float %bitangent
        %387 = OpAccessChain %_ptr_Function_float %ph %uint_1
        %388 = OpLoad %float %387
        %389 = OpVectorTimesScalar %v3float %386 %388
        %390 = OpFAdd %v3float %385 %389
        %391 = OpLoad %v3float %n
        %392 = OpAccessChain %_ptr_Function_float %ph %uint_2
        %393 = OpLoad %float %392
        %394 = OpVectorTimesScalar %v3float %391 %393
        %395 = OpFAdd %v3float %390 %394
               OpReturnValue %395
               OpFunctionEnd
               OpLine %1 156 53
%get_origin_from_depth_f1_vf2_ = OpFunction %v3float None %40
      %depth = OpFunctionParameter %_ptr_Function_float
    %pix_pos = OpFunctionParameter %_ptr_Function_v2float
         %44 = OpLabel
      %pos_0 = OpVariable %_ptr_Function_v3float Function
               OpLine %1 157 0
               OpStore %pos_0 %400
               OpLine %1 159 0
               OpLine %1 161 0
               OpLine %1 160 0
               OpLine %1 159 0
               OpLine %1 160 0
        %407 = OpAccessChain %_ptr_Function_float %pix_pos %uint_0
        %408 = OpLoad %float %407
        %409 = OpVectorTimesScalar %v3float %406 %408
        %411 = OpVectorTimesScalar %v3float %409 %float_45_7142868
        %412 = OpFAdd %v3float %403 %411
               OpLine %1 161 0
        %417 = OpAccessChain %_ptr_Function_float %pix_pos %uint_1
        %418 = OpLoad %float %417
        %419 = OpVectorTimesScalar %v3float %416 %418
        %421 = OpVectorTimesScalar %v3float %419 %float_25_7142849
        %422 = OpFAdd %v3float %412 %421
               OpLine %1 162 0
        %423 = OpLoad %float %depth
        %428 = OpVectorTimesScalar %v3float %427 %423
        %429 = OpFAdd %v3float %422 %428
               OpLine %1 159 0
               OpStore %pos_0 %429
               OpLine %1 164 0
        %430 = OpLoad %v3float %pos_0
               OpReturnValue %430
               OpFunctionEnd
               OpLine %1 167 32
%GetBlock_vi3_ = OpFunction %int None %48
  %block_pos = OpFunctionParameter %_ptr_Function_v3int
         %51 = OpLabel
      %block = OpVariable %_ptr_Function_int Function
               OpLine %1 176 0
        %437 = OpLoad %434 %blocks
        %438 = OpLoad %v3int %block_pos
        %440 = OpImageRead %v4int %437 %438
        %441 = OpCompositeExtract %int %440 0
               OpStore %block %441
               OpLine %1 183 0
        %442 = OpLoad %int %block
               OpReturnValue %442
               OpFunctionEnd
               OpLine %1 186 62
%voxel_in_palette_vi3_i1_ = OpFunction %v3int None %53
%relative_voxel_pos = OpFunctionParameter %_ptr_Function_v3int
   %block_id = OpFunctionParameter %_ptr_Function_int
         %57 = OpLabel
    %block_x = OpVariable %_ptr_Function_int Function
    %block_y = OpVariable %_ptr_Function_int Function
               OpLine %1 187 0
        %446 = OpLoad %int %block_id
        %448 = OpSMod %int %446 %int_32
               OpStore %block_x %448
               OpLine %1 188 0
        %450 = OpLoad %int %block_id
        %451 = OpSDiv %int %450 %int_32
               OpStore %block_y %451
               OpLine %1 190 0
        %452 = OpLoad %v3int %relative_voxel_pos
        %454 = OpLoad %int %block_x
        %455 = OpIMul %int %int_16 %454
        %456 = OpLoad %int %block_y
        %457 = OpIMul %int %int_16 %456
        %459 = OpCompositeConstruct %v3int %455 %457 %int_0
        %460 = OpIAdd %v3int %452 %459
               OpReturnValue %460
               OpFunctionEnd
               OpLine %1 192 26
%GetVoxel_vi3_ = OpFunction %int None %48
        %pos = OpFunctionParameter %_ptr_Function_v3int
         %60 = OpLabel
%block_pos_0 = OpVariable %_ptr_Function_v3int Function
%relative_voxel_pos_0 = OpVariable %_ptr_Function_v3int Function
 %block_id_0 = OpVariable %_ptr_Function_int Function
    %param_3 = OpVariable %_ptr_Function_v3int Function
  %voxel_pos = OpVariable %_ptr_Function_v3int Function
    %param_4 = OpVariable %_ptr_Function_v3int Function
    %param_5 = OpVariable %_ptr_Function_int Function
    %voxel_0 = OpVariable %_ptr_Function_int Function
               OpLine %1 200 0
        %464 = OpLoad %v3int %pos
        %465 = OpCompositeConstruct %v3int %int_16 %int_16 %int_16
        %466 = OpSDiv %v3int %464 %465
               OpStore %block_pos_0 %466
               OpLine %1 201 0
        %468 = OpLoad %v3int %pos
        %469 = OpCompositeConstruct %v3int %int_16 %int_16 %int_16
        %470 = OpSMod %v3int %468 %469
               OpStore %relative_voxel_pos_0 %470
               OpLine %1 203 0
        %473 = OpLoad %v3int %block_pos_0
               OpStore %param_3 %473
        %474 = OpFunctionCall %int %GetBlock_vi3_ %param_3
               OpStore %block_id_0 %474
               OpLine %1 204 0
        %477 = OpLoad %v3int %relative_voxel_pos_0
               OpStore %param_4 %477
        %479 = OpLoad %int %block_id_0
               OpStore %param_5 %479
        %480 = OpFunctionCall %v3int %voxel_in_palette_vi3_i1_ %param_4 %param_5
               OpStore %voxel_pos %480
               OpLine %1 206 0
        %485 = OpLoad %482 %blockPalette
        %486 = OpLoad %v3int %voxel_pos
        %488 = OpImageRead %v4uint %485 %486
        %489 = OpCompositeExtract %uint %488 0
        %490 = OpBitcast %int %489
               OpStore %voxel_0 %490
               OpLine %1 208 0
        %491 = OpLoad %int %voxel_0
               OpReturnValue %491
               OpFunctionEnd
               OpLine %1 226 29
 %GetMat_i1_ = OpFunction %Material None %62
      %voxel = OpFunctionParameter %_ptr_Function_int
         %65 = OpLabel
        %mat = OpVariable %_ptr_Function_Material Function
               OpLine %1 233 0
        %498 = OpLoad %495 %voxelPalette
        %499 = OpLoad %int %voxel
        %500 = OpCompositeConstruct %v2int %int_0 %499
        %502 = OpImageRead %v4float %498 %500
        %503 = OpCompositeExtract %float %502 0
        %504 = OpAccessChain %_ptr_Function_float %mat %int_0 %uint_0
               OpStore %504 %503
               OpLine %1 234 0
        %505 = OpLoad %495 %voxelPalette
        %507 = OpLoad %int %voxel
        %508 = OpCompositeConstruct %v2int %int_1 %507
        %509 = OpImageRead %v4float %505 %508
        %510 = OpCompositeExtract %float %509 0
        %511 = OpAccessChain %_ptr_Function_float %mat %int_0 %uint_1
               OpStore %511 %510
               OpLine %1 235 0
        %512 = OpLoad %495 %voxelPalette
        %514 = OpLoad %int %voxel
        %515 = OpCompositeConstruct %v2int %int_2 %514
        %516 = OpImageRead %v4float %512 %515
        %517 = OpCompositeExtract %float %516 0
        %518 = OpAccessChain %_ptr_Function_float %mat %int_0 %uint_2
               OpStore %518 %517
               OpLine %1 236 0
        %519 = OpLoad %495 %voxelPalette
        %520 = OpLoad %int %voxel
        %521 = OpCompositeConstruct %v2int %int_3 %520
        %522 = OpImageRead %v4float %519 %521
        %523 = OpCompositeExtract %float %522 0
        %524 = OpFSub %float %float_1 %523
        %525 = OpAccessChain %_ptr_Function_float %mat %int_3
               OpStore %525 %524
               OpLine %1 237 0
        %526 = OpLoad %495 %voxelPalette
        %528 = OpLoad %int %voxel
        %529 = OpCompositeConstruct %v2int %int_4 %528
        %530 = OpImageRead %v4float %526 %529
        %531 = OpCompositeExtract %float %530 0
        %532 = OpAccessChain %_ptr_Function_float %mat %int_1
               OpStore %532 %531
               OpLine %1 238 0
        %533 = OpLoad %495 %voxelPalette
        %534 = OpLoad %int %voxel
        %535 = OpCompositeConstruct %v2int %int_5 %534
        %536 = OpImageRead %v4float %533 %535
        %537 = OpCompositeExtract %float %536 0
        %538 = OpAccessChain %_ptr_Function_float %mat %int_2
               OpStore %538 %537
               OpLine %1 248 0
        %539 = OpAccessChain %_ptr_Function_float %mat %int_3
               OpStore %539 %float_0
               OpLine %1 249 0
        %540 = OpAccessChain %_ptr_Function_float %mat %int_2
               OpStore %540 %float_0_5
               OpLine %1 268 0
        %541 = OpLoad %Material %mat
               OpReturnValue %541
               OpFunctionEnd
               OpLine %1 293 107
%initTvals_vf3_vf3_vi3_vf3_vf3_ = OpFunction %bool None %67
       %tMax = OpFunctionParameter %_ptr_Function_v3float
     %tDelta = OpFunctionParameter %_ptr_Function_v3float
   %blockPos = OpFunctionParameter %_ptr_Function_v3int
  %rayOrigin = OpFunctionParameter %_ptr_Function_v3float
%rayDirection = OpFunctionParameter %_ptr_Function_v3float
         %74 = OpLabel
%effective_origin = OpVariable %_ptr_Function_v3float Function
%block_corner1 = OpVariable %_ptr_Function_v3float Function
%block_corner2 = OpVariable %_ptr_Function_v3float Function
               OpLine %1 294 0
        %545 = OpLoad %v3float %rayOrigin
               OpStore %effective_origin %545
               OpLine %1 296 0
        %547 = OpLoad %v3float %effective_origin
        %548 = OpExtInst %v3float %2 Floor %547
               OpStore %block_corner1 %548
               OpLine %1 297 0
        %550 = OpLoad %v3float %block_corner1
        %552 = OpFAdd %v3float %550 %551
               OpStore %block_corner2 %552
               OpLine %1 299 0
        %553 = OpLoad %v3float %block_corner1
        %554 = OpConvertFToS %v3int %553
               OpStore %blockPos %554
               OpLine %1 302 0
        %555 = OpLoad %v3float %effective_origin
        %556 = OpLoad %v3float %block_corner1
        %557 = OpFSub %v3float %556 %555
               OpStore %block_corner1 %557
               OpLine %1 303 0
        %558 = OpLoad %v3float %effective_origin
        %559 = OpLoad %v3float %block_corner2
        %560 = OpFSub %v3float %559 %558
               OpStore %block_corner2 %560
               OpLine %1 305 0
        %561 = OpLoad %v3float %rayDirection
        %562 = OpLoad %v3float %block_corner1
        %563 = OpFDiv %v3float %562 %561
               OpStore %block_corner1 %563
               OpLine %1 306 0
        %564 = OpLoad %v3float %rayDirection
        %565 = OpLoad %v3float %block_corner2
        %566 = OpFDiv %v3float %565 %564
               OpStore %block_corner2 %566
               OpLine %1 308 0
        %567 = OpAccessChain %_ptr_Function_float %block_corner1 %uint_0
        %568 = OpLoad %float %567
        %569 = OpAccessChain %_ptr_Function_float %block_corner2 %uint_0
        %570 = OpLoad %float %569
        %571 = OpExtInst %float %2 FMax %568 %570
        %572 = OpAccessChain %_ptr_Function_float %tMax %uint_0
               OpStore %572 %571
               OpLine %1 309 0
        %573 = OpAccessChain %_ptr_Function_float %block_corner1 %uint_1
        %574 = OpLoad %float %573
        %575 = OpAccessChain %_ptr_Function_float %block_corner2 %uint_1
        %576 = OpLoad %float %575
        %577 = OpExtInst %float %2 FMax %574 %576
        %578 = OpAccessChain %_ptr_Function_float %tMax %uint_1
               OpStore %578 %577
               OpLine %1 310 0
        %579 = OpAccessChain %_ptr_Function_float %block_corner1 %uint_2
        %580 = OpLoad %float %579
        %581 = OpAccessChain %_ptr_Function_float %block_corner2 %uint_2
        %582 = OpLoad %float %581
        %583 = OpExtInst %float %2 FMax %580 %582
        %584 = OpAccessChain %_ptr_Function_float %tMax %uint_2
               OpStore %584 %583
               OpLine %1 312 0
        %585 = OpLoad %v3float %rayDirection
        %586 = OpExtInst %v3float %2 FAbs %585
        %587 = OpCompositeConstruct %v3float %float_1 %float_1 %float_1
        %588 = OpFDiv %v3float %587 %586
               OpStore %tDelta %588
               OpLine %1 314 0
               OpReturnValue %true
               OpFunctionEnd
               OpLine %1 412 134
%CastRay_vf3_vf3_f1_vf3_struct_Material_vf3_f1_f1_f11_f1_ = OpFunction %bool None %76
%rayOrigin_0 = OpFunctionParameter %_ptr_Function_v3float
%rayDirection_0 = OpFunctionParameter %_ptr_Function_v3float
   %fraction = OpFunctionParameter %_ptr_Function_float
     %normal = OpFunctionParameter %_ptr_Function_v3float
   %material = OpFunctionParameter %_ptr_Function_Material
%ignored_voxel = OpFunctionParameter %_ptr_Function_float
         %84 = OpLabel
  %block_hit = OpVariable %_ptr_Function_bool Function
      %steps = OpVariable %_ptr_Function_v3int Function
     %fsteps = OpVariable %_ptr_Function_v3float Function
     %tMax_0 = OpVariable %_ptr_Function_v3float Function
   %tDelta_0 = OpVariable %_ptr_Function_v3float Function
%voxel_pos_0 = OpVariable %_ptr_Function_v3int Function
%block_fraction = OpVariable %_ptr_Function_float Function
%What_Is_Step = OpVariable %_ptr_Function_int Function
%istep_Diretion = OpVariable %_ptr_Function_v3int Function
%fcurrentStepDiretion = OpVariable %_ptr_Function_v3float Function
    %param_6 = OpVariable %_ptr_Function_v3float Function
    %param_7 = OpVariable %_ptr_Function_v3float Function
    %param_8 = OpVariable %_ptr_Function_v3int Function
    %param_9 = OpVariable %_ptr_Function_v3float Function
   %param_10 = OpVariable %_ptr_Function_v3float Function
%current_voxel = OpVariable %_ptr_Function_int Function
   %param_11 = OpVariable %_ptr_Function_v3int Function
 %iterations = OpVariable %_ptr_Function_int Function
   %param_12 = OpVariable %_ptr_Function_v3int Function
     %tFinal = OpVariable %_ptr_Function_v3float Function
   %param_13 = OpVariable %_ptr_Function_int Function
               OpLine %1 413 0
               OpStore %block_hit %false
               OpLine %1 416 0
        %595 = OpAccessChain %_ptr_Function_float %rayDirection_0 %uint_0
        %596 = OpLoad %float %595
        %597 = OpFOrdGreaterThan %bool %596 %float_0
        %598 = OpSelect %int %597 %int_1 %int_0
        %599 = OpAccessChain %_ptr_Function_int %steps %uint_0
               OpStore %599 %598
               OpLine %1 417 0
        %600 = OpAccessChain %_ptr_Function_float %rayDirection_0 %uint_1
        %601 = OpLoad %float %600
        %602 = OpFOrdGreaterThan %bool %601 %float_0
        %603 = OpSelect %int %602 %int_1 %int_0
        %604 = OpAccessChain %_ptr_Function_int %steps %uint_1
               OpStore %604 %603
               OpLine %1 418 0
        %605 = OpAccessChain %_ptr_Function_float %rayDirection_0 %uint_2
        %606 = OpLoad %float %605
        %607 = OpFOrdGreaterThan %bool %606 %float_0
        %608 = OpSelect %int %607 %int_1 %int_0
        %609 = OpAccessChain %_ptr_Function_int %steps %uint_2
               OpStore %609 %608
               OpLine %1 419 0
        %610 = OpLoad %v3int %steps
        %611 = OpCompositeConstruct %v3int %int_2 %int_2 %int_2
        %612 = OpIMul %v3int %611 %610
        %613 = OpCompositeConstruct %v3int %int_1 %int_1 %int_1
        %614 = OpISub %v3int %612 %613
               OpStore %steps %614
               OpLine %1 421 0
        %616 = OpLoad %v3int %steps
        %617 = OpConvertSToF %v3float %616
               OpStore %fsteps %617
               OpLine %1 423 0
               OpStore %tMax_0 %400
               OpLine %1 424 0
               OpStore %tDelta_0 %400
               OpLine %1 425 0
               OpStore %voxel_pos_0 %621
               OpLine %1 426 0
               OpStore %block_fraction %float_0
               OpLine %1 428 0
               OpStore %What_Is_Step %int_0
               OpLine %1 429 0
               OpStore %istep_Diretion %621
               OpLine %1 430 0
               OpStore %fcurrentStepDiretion %400
               OpLine %1 432 0
        %630 = OpLoad %v3float %rayOrigin_0
               OpStore %param_9 %630
        %632 = OpLoad %v3float %rayDirection_0
               OpStore %param_10 %632
        %633 = OpFunctionCall %bool %initTvals_vf3_vf3_vi3_vf3_vf3_ %param_6 %param_7 %param_8 %param_9 %param_10
        %634 = OpLoad %v3float %param_6
               OpStore %tMax_0 %634
        %635 = OpLoad %v3float %param_7
               OpStore %tDelta_0 %635
        %636 = OpLoad %v3int %param_8
               OpStore %voxel_pos_0 %636
        %637 = OpLogicalNot %bool %633
               OpSelectionMerge %639 None
               OpBranchConditional %637 %638 %639
        %638 = OpLabel
               OpLine %1 432 0
               OpReturnValue %false
        %639 = OpLabel
               OpLine %1 434 0
        %643 = OpLoad %v3int %voxel_pos_0
               OpStore %param_11 %643
        %644 = OpFunctionCall %int %GetVoxel_vi3_ %param_11
               OpStore %current_voxel %644
               OpLine %1 435 0
               OpStore %iterations %int_0
               OpBranch %646
        %646 = OpLabel
               OpLine %1 436 0
               OpLoopMerge %648 %649 None
               OpBranch %650
        %650 = OpLabel
               OpBranchConditional %true %647 %648
        %647 = OpLabel
               OpLine %1 438 0
        %651 = OpAccessChain %_ptr_Function_float %tMax_0 %uint_0
        %652 = OpLoad %float %651
        %653 = OpAccessChain %_ptr_Function_float %tMax_0 %uint_1
        %654 = OpLoad %float %653
        %655 = OpFOrdLessThanEqual %bool %652 %654
               OpSelectionMerge %657 None
               OpBranchConditional %655 %656 %657
        %656 = OpLabel
               OpLine %1 438 0
        %658 = OpAccessChain %_ptr_Function_float %tMax_0 %uint_0
        %659 = OpLoad %float %658
        %660 = OpAccessChain %_ptr_Function_float %tMax_0 %uint_2
        %661 = OpLoad %float %660
        %662 = OpFOrdLessThanEqual %bool %659 %661
               OpBranch %657
        %657 = OpLabel
        %663 = OpPhi %bool %655 %647 %662 %656
        %664 = OpSelect %int %663 %int_1 %int_0
        %665 = OpConvertSToF %float %664
               OpLine %1 438 0
        %666 = OpAccessChain %_ptr_Function_float %fcurrentStepDiretion %uint_0
               OpStore %666 %665
               OpLine %1 439 0
        %667 = OpAccessChain %_ptr_Function_float %tMax_0 %uint_0
        %668 = OpLoad %float %667
        %669 = OpAccessChain %_ptr_Function_float %tMax_0 %uint_1
        %670 = OpLoad %float %669
        %671 = OpFOrdGreaterThanEqual %bool %668 %670
               OpSelectionMerge %673 None
               OpBranchConditional %671 %672 %673
        %672 = OpLabel
               OpLine %1 439 0
        %674 = OpAccessChain %_ptr_Function_float %tMax_0 %uint_1
        %675 = OpLoad %float %674
        %676 = OpAccessChain %_ptr_Function_float %tMax_0 %uint_2
        %677 = OpLoad %float %676
        %678 = OpFOrdLessThanEqual %bool %675 %677
               OpBranch %673
        %673 = OpLabel
        %679 = OpPhi %bool %671 %657 %678 %672
        %680 = OpSelect %int %679 %int_1 %int_0
        %681 = OpConvertSToF %float %680
               OpLine %1 439 0
        %682 = OpAccessChain %_ptr_Function_float %fcurrentStepDiretion %uint_1
               OpStore %682 %681
               OpLine %1 440 0
        %683 = OpAccessChain %_ptr_Function_float %tMax_0 %uint_2
        %684 = OpLoad %float %683
        %685 = OpAccessChain %_ptr_Function_float %tMax_0 %uint_0
        %686 = OpLoad %float %685
        %687 = OpFOrdLessThanEqual %bool %684 %686
               OpSelectionMerge %689 None
               OpBranchConditional %687 %688 %689
        %688 = OpLabel
               OpLine %1 440 0
        %690 = OpAccessChain %_ptr_Function_float %tMax_0 %uint_2
        %691 = OpLoad %float %690
        %692 = OpAccessChain %_ptr_Function_float %tMax_0 %uint_1
        %693 = OpLoad %float %692
        %694 = OpFOrdLessThanEqual %bool %691 %693
               OpBranch %689
        %689 = OpLabel
        %695 = OpPhi %bool %687 %673 %694 %688
        %696 = OpSelect %int %695 %int_1 %int_0
        %697 = OpConvertSToF %float %696
               OpLine %1 440 0
        %698 = OpAccessChain %_ptr_Function_float %fcurrentStepDiretion %uint_2
               OpStore %698 %697
               OpLine %1 442 0
        %699 = OpLoad %v3int %steps
        %700 = OpLoad %v3float %fcurrentStepDiretion
        %701 = OpConvertFToS %v3int %700
        %702 = OpIMul %v3int %699 %701
        %703 = OpLoad %v3int %voxel_pos_0
        %704 = OpIAdd %v3int %703 %702
               OpStore %voxel_pos_0 %704
               OpLine %1 443 0
        %705 = OpLoad %v3float %tDelta_0
        %706 = OpLoad %v3float %fcurrentStepDiretion
        %707 = OpFMul %v3float %705 %706
        %708 = OpLoad %v3float %tMax_0
        %709 = OpFAdd %v3float %708 %707
               OpStore %tMax_0 %709
               OpLine %1 445 0
        %711 = OpLoad %v3int %voxel_pos_0
               OpStore %param_12 %711
        %712 = OpFunctionCall %int %GetVoxel_vi3_ %param_12
               OpStore %current_voxel %712
               OpLine %1 448 0
        %713 = OpLoad %v3int %voxel_pos_0
        %715 = OpSLessThan %v3bool %713 %621
        %716 = OpAny %bool %715
        %717 = OpLogicalNot %bool %716
               OpSelectionMerge %719 None
               OpBranchConditional %717 %718 %719
        %718 = OpLabel
               OpLine %1 448 0
        %720 = OpLoad %v3int %voxel_pos_0
        %723 = OpSGreaterThanEqual %v3bool %720 %722
        %724 = OpAny %bool %723
               OpBranch %719
        %719 = OpLabel
        %725 = OpPhi %bool %716 %689 %724 %718
               OpSelectionMerge %727 None
               OpBranchConditional %725 %726 %727
        %726 = OpLabel
               OpLine %1 449 0
               OpStore %block_hit %false
               OpLine %1 450 0
               OpBranch %648
        %727 = OpLabel
               OpLine %1 452 0
        %729 = OpLoad %int %current_voxel
        %730 = OpINotEqual %bool %729 %int_0
               OpSelectionMerge %732 None
               OpBranchConditional %730 %731 %732
        %731 = OpLabel
               OpLine %1 455 0
               OpStore %block_hit %true
               OpLine %1 456 0
               OpBranch %648
        %732 = OpLabel
               OpLine %1 458 0
        %734 = OpLoad %int %iterations
        %735 = OpIAdd %int %734 %int_1
               OpStore %iterations %735
        %737 = OpSGreaterThanEqual %bool %734 %int_100
               OpSelectionMerge %739 None
               OpBranchConditional %737 %738 %739
        %738 = OpLabel
               OpLine %1 459 0
               OpStore %block_hit %false
               OpLine %1 460 0
               OpBranch %648
        %739 = OpLabel
               OpBranch %649
        %649 = OpLabel
               OpBranch %646
        %648 = OpLabel
               OpLine %1 464 0
        %741 = OpLoad %v3float %fsteps
        %742 = OpLoad %v3float %fcurrentStepDiretion
        %743 = OpFMul %v3float %741 %742
        %744 = OpFNegate %v3float %743
               OpStore %normal %744
               OpLine %1 465 0
        %746 = OpLoad %v3float %tMax_0
        %747 = OpLoad %v3float %tDelta_0
        %748 = OpFSub %v3float %746 %747
               OpStore %tFinal %748
               OpLine %1 467 0
        %749 = OpLoad %v3float %tFinal
        %750 = OpLoad %v3float %fcurrentStepDiretion
        %751 = OpDot %float %749 %750
               OpStore %block_fraction %751
               OpLine %1 469 0
        %753 = OpLoad %int %current_voxel
               OpStore %param_13 %753
        %754 = OpFunctionCall %Material %GetMat_i1_ %param_13
               OpStore %material %754
               OpLine %1 470 0
        %755 = OpLoad %float %block_fraction
               OpStore %fraction %755
               OpLine %1 472 0
        %756 = OpLoad %bool %block_hit
               OpReturnValue %756
               OpFunctionEnd
               OpLine %1 475 55
%FresnelSchlick_vf3_vf3_ = OpFunction %float None %85
  %direction = OpFunctionParameter %_ptr_Function_v3float
   %normal_0 = OpFunctionParameter %_ptr_Function_v3float
         %89 = OpLabel
      %nIn_0 = OpVariable %_ptr_Function_float Function
     %nOut_0 = OpVariable %_ptr_Function_float Function
         %R0 = OpVariable %_ptr_Function_float Function
    %fresnel = OpVariable %_ptr_Function_float Function
               OpLine %1 476 0
               OpStore %nIn_0 %float_1
               OpLine %1 477 0
               OpStore %nOut_0 %float_1
               OpLine %1 478 0
        %762 = OpLoad %float %nOut_0
        %763 = OpLoad %float %nIn_0
        %764 = OpFSub %float %762 %763
        %765 = OpLoad %float %nOut_0
        %766 = OpLoad %float %nIn_0
        %767 = OpFSub %float %765 %766
        %768 = OpFMul %float %764 %767
        %769 = OpLoad %float %nOut_0
        %770 = OpLoad %float %nIn_0
        %771 = OpFAdd %float %769 %770
        %772 = OpLoad %float %nOut_0
        %773 = OpLoad %float %nIn_0
        %774 = OpFAdd %float %772 %773
        %775 = OpFMul %float %771 %774
        %776 = OpFDiv %float %768 %775
               OpStore %R0 %776
               OpLine %1 479 0
        %778 = OpLoad %float %R0
        %779 = OpLoad %float %R0
        %780 = OpFSub %float %float_1 %779
        %781 = OpLoad %v3float %direction
        %782 = OpLoad %v3float %normal_0
        %783 = OpDot %float %781 %782
        %784 = OpExtInst %float %2 FAbs %783
        %785 = OpFSub %float %float_1 %784
        %787 = OpExtInst %float %2 Pow %785 %float_5
        %788 = OpFMul %float %780 %787
        %789 = OpFAdd %float %778 %788
               OpStore %fresnel %789
               OpLine %1 480 0
        %790 = OpLoad %float %fresnel
               OpReturnValue %790
               OpFunctionEnd
               OpLine %1 482 69
%IdealRefract_vf3_vf3_f1_f1_ = OpFunction %v3float None %90
%direction_0 = OpFunctionParameter %_ptr_Function_v3float
   %normal_1 = OpFunctionParameter %_ptr_Function_v3float
        %nIn = OpFunctionParameter %_ptr_Function_float
       %nOut = OpFunctionParameter %_ptr_Function_float
         %96 = OpLabel
%fromOutside = OpVariable %_ptr_Function_bool Function
      %ratio = OpVariable %_ptr_Function_float Function
        %800 = OpVariable %_ptr_Function_float Function
 %refraction = OpVariable %_ptr_Function_v3float Function
        %813 = OpVariable %_ptr_Function_v3float Function
 %reflection = OpVariable %_ptr_Function_v3float Function
               OpLine %1 485 0
        %794 = OpLoad %v3float %normal_1
        %795 = OpLoad %v3float %direction_0
        %796 = OpDot %float %794 %795
        %797 = OpFOrdLessThan %bool %796 %float_0
               OpStore %fromOutside %797
               OpLine %1 486 0
        %799 = OpLoad %bool %fromOutside
               OpSelectionMerge %802 None
               OpBranchConditional %799 %801 %806
        %801 = OpLabel
               OpLine %1 486 0
        %803 = OpLoad %float %nOut
        %804 = OpLoad %float %nIn
        %805 = OpFDiv %float %803 %804
               OpStore %800 %805
               OpBranch %802
        %806 = OpLabel
               OpLine %1 486 0
        %807 = OpLoad %float %nIn
        %808 = OpLoad %float %nOut
        %809 = OpFDiv %float %807 %808
               OpStore %800 %809
               OpBranch %802
        %802 = OpLabel
        %810 = OpLoad %float %800
               OpLine %1 486 0
               OpStore %ratio %810
               OpLine %1 489 0
        %812 = OpLoad %bool %fromOutside
               OpSelectionMerge %815 None
               OpBranchConditional %812 %814 %820
        %814 = OpLabel
               OpLine %1 489 0
        %816 = OpLoad %v3float %direction_0
        %817 = OpLoad %v3float %normal_1
        %818 = OpLoad %float %ratio
        %819 = OpExtInst %v3float %2 Refract %816 %817 %818
               OpStore %813 %819
               OpBranch %815
        %820 = OpLabel
               OpLine %1 489 0
        %821 = OpLoad %v3float %direction_0
        %822 = OpFNegate %v3float %821
        %823 = OpLoad %v3float %normal_1
        %824 = OpLoad %float %ratio
        %825 = OpExtInst %v3float %2 Refract %822 %823 %824
        %826 = OpFNegate %v3float %825
               OpStore %813 %826
               OpBranch %815
        %815 = OpLabel
        %827 = OpLoad %v3float %813
               OpLine %1 489 0
               OpStore %refraction %827
               OpLine %1 490 0
        %829 = OpLoad %v3float %direction_0
        %830 = OpLoad %v3float %normal_1
        %831 = OpExtInst %v3float %2 Reflect %829 %830
               OpStore %reflection %831
               OpLine %1 493 0
        %832 = OpLoad %v3float %refraction
        %833 = OpFOrdEqual %v3bool %832 %400
        %834 = OpAll %bool %833
        %835 = OpLoad %v3float %reflection
        %836 = OpLoad %v3float %refraction
        %837 = OpCompositeConstruct %v3bool %834 %834 %834
        %838 = OpSelect %v3float %837 %835 %836
               OpReturnValue %838
               OpFunctionEnd
               OpLine %1 495 77
%IsRefracted_vf3_vf3_f1_ = OpFunction %bool None %97
%rayDirection_1 = OpFunctionParameter %_ptr_Function_v3float
   %normal_2 = OpFunctionParameter %_ptr_Function_v3float
%transparancy = OpFunctionParameter %_ptr_Function_float
        %102 = OpLabel
  %fresnel_0 = OpVariable %_ptr_Function_float Function
   %param_14 = OpVariable %_ptr_Function_v3float Function
   %param_15 = OpVariable %_ptr_Function_v3float Function
     %rand_0 = OpVariable %_ptr_Function_float Function
               OpLine %1 496 0
        %843 = OpLoad %v3float %rayDirection_1
               OpStore %param_14 %843
        %845 = OpLoad %v3float %normal_2
               OpStore %param_15 %845
        %846 = OpFunctionCall %float %FresnelSchlick_vf3_vf3_ %param_14 %param_15
               OpStore %fresnel_0 %846
               OpLine %1 497 0
        %848 = OpFunctionCall %float %RandomFloat_0to1_
               OpStore %rand_0 %848
               OpLine %1 498 0
        %849 = OpLoad %float %transparancy
        %850 = OpLoad %float %rand_0
        %851 = OpFOrdGreaterThan %bool %849 %850
        %852 = OpLoad %float %fresnel_0
        %853 = OpLoad %float %rand_0
        %854 = OpFOrdLessThan %bool %852 %853
        %855 = OpLogicalAnd %bool %851 %854
               OpReturnValue %855
               OpFunctionEnd
               OpLine %1 503 80
%ProcessHit_vf3_vf3_f1_vf3_struct_Material_vf3_f1_f1_f11_vf3_vf3_ = OpFunction %void None %103
     %origin = OpFunctionParameter %_ptr_Function_v3float
%direction_1 = OpFunctionParameter %_ptr_Function_v3float
 %fraction_0 = OpFunctionParameter %_ptr_Function_float
   %normal_3 = OpFunctionParameter %_ptr_Function_v3float
 %material_0 = OpFunctionParameter %_ptr_Function_Material
%accumulated_light = OpFunctionParameter %_ptr_Function_v3float
%accumulated_reflection = OpFunctionParameter %_ptr_Function_v3float
        %112 = OpLabel
 %new_origin = OpVariable %_ptr_Function_v3float Function
%hemisphereDistributedDirection = OpVariable %_ptr_Function_v3float Function
   %param_16 = OpVariable %_ptr_Function_v3float Function
   %param_17 = OpVariable %_ptr_Function_v3float Function
%new_direction = OpVariable %_ptr_Function_v3float Function
  %refracted = OpVariable %_ptr_Function_bool Function
   %param_18 = OpVariable %_ptr_Function_v3float Function
   %param_19 = OpVariable %_ptr_Function_v3float Function
   %param_20 = OpVariable %_ptr_Function_float Function
%idealRefraction = OpVariable %_ptr_Function_v3float Function
   %param_21 = OpVariable %_ptr_Function_v3float Function
   %param_22 = OpVariable %_ptr_Function_v3float Function
   %param_23 = OpVariable %_ptr_Function_float Function
   %param_24 = OpVariable %_ptr_Function_float Function
%idealReflection = OpVariable %_ptr_Function_v3float Function
               OpLine %1 505 0
        %859 = OpLoad %v3float %origin
        %860 = OpLoad %float %fraction_0
        %861 = OpLoad %v3float %direction_1
        %862 = OpVectorTimesScalar %v3float %861 %860
        %863 = OpFAdd %v3float %859 %862
               OpStore %new_origin %863
               OpLine %1 508 0
        %865 = OpFunctionCall %v3float %Random3D_
               OpStore %param_16 %865
        %868 = OpLoad %v3float %normal_3
               OpStore %param_17 %868
        %869 = OpFunctionCall %v3float %randomCosineWeightedHemispherePoint_vf3_vf3_ %param_16 %param_17
               OpStore %hemisphereDistributedDirection %869
               OpLine %1 514 0
        %871 = OpLoad %v3float %hemisphereDistributedDirection
               OpStore %new_direction %871
               OpLine %1 516 0
        %874 = OpLoad %v3float %direction_1
               OpStore %param_18 %874
        %876 = OpLoad %v3float %normal_3
               OpStore %param_19 %876
        %878 = OpAccessChain %_ptr_Function_float %material_0 %int_3
        %879 = OpLoad %float %878
               OpStore %param_20 %879
        %880 = OpFunctionCall %bool %IsRefracted_vf3_vf3_f1_ %param_18 %param_19 %param_20
               OpStore %refracted %880
               OpLine %1 517 0
               OpStore %refracted %false
               OpLine %1 518 0
        %881 = OpLoad %bool %refracted
               OpSelectionMerge %883 None
               OpBranchConditional %881 %882 %911
        %882 = OpLabel
               OpLine %1 520 0
        %886 = OpLoad %v3float %direction_1
               OpStore %param_21 %886
        %888 = OpLoad %v3float %normal_3
               OpStore %param_22 %888
               OpStore %param_23 %float_1
               OpStore %param_24 %float_1
        %891 = OpFunctionCall %v3float %IdealRefract_vf3_vf3_f1_f1_ %param_21 %param_22 %param_23 %param_24
               OpStore %idealRefraction %891
               OpLine %1 521 0
        %892 = OpLoad %v3float %new_direction
        %893 = OpFNegate %v3float %892
        %894 = OpLoad %v3float %idealRefraction
        %895 = OpAccessChain %_ptr_Function_float %material_0 %int_2
        %896 = OpLoad %float %895
        %897 = OpCompositeConstruct %v3float %896 %896 %896
        %898 = OpExtInst %v3float %2 FMix %893 %894 %897
        %899 = OpExtInst %v3float %2 Normalize %898
               OpStore %new_direction %899
               OpLine %1 523 0
        %900 = OpLoad %v3float %normal_3
        %901 = OpLoad %v3float %new_direction
        %902 = OpLoad %v3float %normal_3
        %903 = OpDot %float %901 %902
        %904 = OpFOrdLessThan %bool %903 %float_0
        %907 = OpSelect %float %904 %float_n0_00100000005 %float_0_00100000005
        %908 = OpVectorTimesScalar %v3float %900 %907
        %909 = OpLoad %v3float %new_origin
        %910 = OpFAdd %v3float %909 %908
               OpStore %new_origin %910
               OpBranch %883
        %911 = OpLabel
               OpLine %1 527 0
        %913 = OpLoad %v3float %direction_1
        %914 = OpLoad %v3float %normal_3
        %915 = OpExtInst %v3float %2 Reflect %913 %914
               OpStore %idealReflection %915
               OpLine %1 528 0
        %916 = OpLoad %v3float %new_direction
        %917 = OpLoad %v3float %idealReflection
        %918 = OpAccessChain %_ptr_Function_float %material_0 %int_2
        %919 = OpLoad %float %918
        %920 = OpCompositeConstruct %v3float %919 %919 %919
        %921 = OpExtInst %v3float %2 FMix %916 %917 %920
        %922 = OpExtInst %v3float %2 Normalize %921
               OpStore %new_direction %922
               OpLine %1 529 0
        %923 = OpLoad %v3float %normal_3
        %924 = OpVectorTimesScalar %v3float %923 %float_0_00100000005
        %925 = OpLoad %v3float %new_origin
        %926 = OpFAdd %v3float %925 %924
               OpStore %new_origin %926
               OpLine %1 530 0
        %927 = OpAccessChain %_ptr_Function_v3float %material_0 %int_0
        %928 = OpLoad %v3float %927
        %929 = OpLoad %v3float %accumulated_reflection
        %930 = OpFMul %v3float %929 %928
               OpStore %accumulated_reflection %930
               OpLine %1 531 0
        %931 = OpLoad %v3float %accumulated_reflection
        %932 = OpAccessChain %_ptr_Function_float %material_0 %int_1
        %933 = OpLoad %float %932
        %934 = OpVectorTimesScalar %v3float %931 %933
        %935 = OpLoad %v3float %accumulated_light
        %936 = OpFAdd %v3float %935 %934
               OpStore %accumulated_light %936
               OpBranch %883
        %883 = OpLabel
               OpLine %1 538 0
        %937 = OpLoad %v3float %new_direction
               OpStore %direction_1 %937
               OpLine %1 539 0
        %938 = OpLoad %v3float %new_origin
               OpStore %origin %938
               OpReturn
               OpFunctionEnd
               OpLine %1 543 137
%TraceRay_vf3_vf3_vf3_vf3_f1_ = OpFunction %v3float None %113
%rayOrigin_1 = OpFunctionParameter %_ptr_Function_v3float
%rayDirection_2 = OpFunctionParameter %_ptr_Function_v3float
%accumulated_light_0 = OpFunctionParameter %_ptr_Function_v3float
%accumulated_reflection_0 = OpFunctionParameter %_ptr_Function_v3float
%ignored_voxel_0 = OpFunctionParameter %_ptr_Function_float
        %120 = OpLabel
 %fraction_2 = OpVariable %_ptr_Function_float Function
   %normal_5 = OpVariable %_ptr_Function_v3float Function
          %i = OpVariable %_ptr_Function_int Function
        %hit = OpVariable %_ptr_Function_bool Function
 %material_2 = OpVariable %_ptr_Function_Material Function
   %param_25 = OpVariable %_ptr_Function_v3float Function
   %param_26 = OpVariable %_ptr_Function_v3float Function
   %param_27 = OpVariable %_ptr_Function_float Function
   %param_28 = OpVariable %_ptr_Function_v3float Function
   %param_29 = OpVariable %_ptr_Function_Material Function
   %param_30 = OpVariable %_ptr_Function_float Function
   %param_31 = OpVariable %_ptr_Function_v3float Function
   %param_32 = OpVariable %_ptr_Function_v3float Function
   %param_33 = OpVariable %_ptr_Function_float Function
   %param_34 = OpVariable %_ptr_Function_v3float Function
   %param_35 = OpVariable %_ptr_Function_Material Function
   %param_36 = OpVariable %_ptr_Function_v3float Function
   %param_37 = OpVariable %_ptr_Function_v3float Function
%global_light_participance = OpVariable %_ptr_Function_float Function
               OpLine %1 547 0
               OpStore %fraction_2 %float_0
               OpLine %1 548 0
               OpStore %normal_5 %400
               OpLine %1 551 0
               OpStore %i %int_0
               OpBranch %942
        %942 = OpLabel
               OpLine %1 551 0
               OpLoopMerge %944 %945 None
               OpBranch %946
        %946 = OpLabel
               OpLine %1 551 0
        %947 = OpLoad %int %i
        %948 = OpSLessThan %bool %947 %int_3
               OpBranchConditional %948 %943 %944
        %943 = OpLabel
               OpLine %1 553 0
        %952 = OpLoad %v3float %rayOrigin_1
               OpStore %param_25 %952
        %954 = OpLoad %v3float %rayDirection_2
               OpStore %param_26 %954
        %959 = OpLoad %float %ignored_voxel_0
               OpStore %param_30 %959
        %960 = OpFunctionCall %bool %CastRay_vf3_vf3_f1_vf3_struct_Material_vf3_f1_f1_f11_f1_ %param_25 %param_26 %param_27 %param_28 %param_29 %param_30
        %961 = OpLoad %float %param_27
               OpStore %fraction_2 %961
        %962 = OpLoad %v3float %param_28
               OpStore %normal_5 %962
        %963 = OpLoad %Material %param_29
               OpStore %material_2 %963
               OpStore %hit %960
               OpLine %1 554 0
               OpStore %ignored_voxel_0 %float_999
               OpLine %1 555 0
        %965 = OpLoad %bool %hit
               OpSelectionMerge %967 None
               OpBranchConditional %965 %966 %967
        %966 = OpLabel
               OpLine %1 560 0
               OpLine %1 558 0
               OpLine %1 559 0
               OpLine %1 560 0
        %969 = OpLoad %v3float %rayOrigin_1
               OpStore %param_31 %969
        %971 = OpLoad %v3float %rayDirection_2
               OpStore %param_32 %971
        %973 = OpLoad %float %fraction_2
               OpStore %param_33 %973
        %975 = OpLoad %v3float %normal_5
               OpStore %param_34 %975
        %977 = OpLoad %Material %material_2
               OpStore %param_35 %977
        %979 = OpLoad %v3float %accumulated_light_0
               OpStore %param_36 %979
        %981 = OpLoad %v3float %accumulated_reflection_0
               OpStore %param_37 %981
        %982 = OpFunctionCall %void %ProcessHit_vf3_vf3_f1_vf3_struct_Material_vf3_f1_f1_f11_vf3_vf3_ %param_31 %param_32 %param_33 %param_34 %param_35 %param_36 %param_37
        %983 = OpLoad %v3float %param_31
               OpStore %rayOrigin_1 %983
        %984 = OpLoad %v3float %param_32
               OpStore %rayDirection_2 %984
        %985 = OpLoad %v3float %param_36
               OpStore %accumulated_light_0 %985
        %986 = OpLoad %v3float %param_37
               OpStore %accumulated_reflection_0 %986
               OpBranch %967
        %967 = OpLabel
               OpLine %1 596 0
        %987 = OpLoad %v3float %accumulated_reflection_0
        %988 = OpExtInst %float %2 Length %987
        %990 = OpFOrdLessThan %bool %988 %float_0_00999999978
        %991 = OpLogicalNot %bool %990
               OpSelectionMerge %993 None
               OpBranchConditional %991 %992 %993
        %992 = OpLabel
               OpLine %1 596 0
        %994 = OpLoad %v3float %accumulated_light_0
        %995 = OpExtInst %float %2 Length %994
        %997 = OpFOrdGreaterThan %bool %995 %float_1_73205078
               OpBranch %993
        %993 = OpLabel
        %998 = OpPhi %bool %990 %967 %997 %992
               OpSelectionMerge %1000 None
               OpBranchConditional %998 %999 %1002
        %999 = OpLabel
               OpLine %1 596 0
               OpBranch %944
       %1002 = OpLabel
               OpLine %1 598 0
               OpBranch %944
       %1000 = OpLabel
               OpUnreachable
        %945 = OpLabel
               OpBranch %942
        %944 = OpLabel
               OpLine %1 602 0
       %1007 = OpLoad %v3float %rayDirection_2
       %1012 = OpDot %float %1007 %1011
       %1013 = OpFNegate %float %1012
               OpStore %global_light_participance %1013
               OpLine %1 603 0
       %1014 = OpLoad %float %global_light_participance
       %1015 = OpFOrdGreaterThan %bool %1014 %float_0
               OpSelectionMerge %1017 None
               OpBranchConditional %1015 %1016 %1017
       %1016 = OpLabel
               OpLine %1 604 0
       %1021 = OpLoad %v3float %accumulated_reflection_0
       %1022 = OpFMul %v3float %1020 %1021
       %1023 = OpLoad %float %global_light_participance
       %1024 = OpVectorTimesScalar %v3float %1022 %1023
       %1025 = OpLoad %v3float %accumulated_light_0
       %1026 = OpFAdd %v3float %1025 %1024
               OpStore %accumulated_light_0 %1026
               OpBranch %1017
       %1017 = OpLabel
               OpLine %1 607 0
       %1027 = OpLoad %v3float %accumulated_light_0
               OpReturnValue %1027
               OpFunctionEnd
               OpLine %1 615 29
%load_depth_vi2_ = OpFunction %float None %123
      %pixel = OpFunctionParameter %_ptr_Function_v2int
        %126 = OpLabel
               OpLine %1 616 0
       %1033 = OpLoad %1030 %posMat
       %1034 = OpLoad %v2int %pixel
       %1035 = OpCompositeExtract %int %1034 0
       %1036 = OpCompositeExtract %int %1034 1
       %1037 = OpCompositeConstruct %v2int %1035 %1036
       %1038 = OpImageRead %v4float %1033 %1037
       %1039 = OpCompositeExtract %float %1038 0
               OpReturnValue %1039
               OpFunctionEnd
               OpLine %1 618 27
%load_norm_vi2_ = OpFunction %v3float None %127
    %pixel_0 = OpFunctionParameter %_ptr_Function_v2int
        %130 = OpLabel
               OpLine %1 619 0
       %1043 = OpLoad %1030 %norms
       %1044 = OpLoad %v2int %pixel_0
       %1045 = OpCompositeExtract %int %1044 0
       %1046 = OpCompositeExtract %int %1044 1
       %1047 = OpCompositeConstruct %v2int %1045 %1046
       %1048 = OpImageRead %v4float %1043 %1047
       %1049 = OpVectorShuffle %v3float %1048 %1048 0 1 2
               OpReturnValue %1049
               OpFunctionEnd
               OpLine %1 621 85
%ssr_intersects_f1_vf2_b1_ = OpFunction %bool None %132
 %test_depth = OpFunctionParameter %_ptr_Function_float
        %pix = OpFunctionParameter %_ptr_Function_v2float
%smooth_intersection = OpFunctionParameter %_ptr_Function_bool
        %137 = OpLabel
    %depth_0 = OpVariable %_ptr_Function_float Function
   %param_38 = OpVariable %_ptr_Function_v2int Function
       %diff = OpVariable %_ptr_Function_float Function
        %ssr = OpVariable %_ptr_Function_bool Function
               OpLine %1 622 0
       %1053 = OpLoad %v2float %pix
       %1054 = OpConvertFToS %v2int %1053
               OpStore %param_38 %1054
       %1056 = OpFunctionCall %float %load_depth_vi2_ %param_38
               OpStore %depth_0 %1056
               OpLine %1 623 0
       %1058 = OpLoad %float %test_depth
       %1059 = OpLoad %float %depth_0
       %1060 = OpFSub %float %1058 %1059
               OpStore %diff %1060
               OpLine %1 624 0
               OpStore %ssr %false
               OpLine %1 625 0
               OpStore %smooth_intersection %false
               OpLine %1 626 0
       %1062 = OpLoad %float %diff
       %1063 = OpFOrdGreaterThan %bool %1062 %float_0
               OpSelectionMerge %1065 None
               OpBranchConditional %1063 %1064 %1065
       %1064 = OpLabel
               OpLine %1 626 0
               OpStore %ssr %true
               OpBranch %1065
       %1065 = OpLabel
               OpLine %1 627 0
       %1066 = OpLoad %float %diff
       %1067 = OpFOrdLessThan %bool %1066 %float_1
               OpSelectionMerge %1069 None
               OpBranchConditional %1067 %1068 %1069
       %1068 = OpLabel
               OpLine %1 627 0
               OpStore %smooth_intersection %true
               OpBranch %1069
       %1069 = OpLabel
               OpLine %1 629 0
       %1070 = OpLoad %bool %ssr
               OpReturnValue %1070
               OpFunctionEnd
               OpLine %1 631 131
%ssr_traceRay_vf3_vf3_vf2_f1_vf3_struct_Material_vf3_f1_f1_f11_ = OpFunction %bool None %138
   %origin_0 = OpFunctionParameter %_ptr_Function_v3float
%direction_2 = OpFunctionParameter %_ptr_Function_v3float
  %start_pix = OpFunctionParameter %_ptr_Function_v2float
 %fraction_1 = OpFunctionParameter %_ptr_Function_float
   %normal_4 = OpFunctionParameter %_ptr_Function_v3float
 %material_1 = OpFunctionParameter %_ptr_Function_Material
        %146 = OpLabel
    %counter = OpVariable %_ptr_Function_int Function
%smooth_intersection_0 = OpVariable %_ptr_Function_bool Function
%fraction_step = OpVariable %_ptr_Function_float Function
      %pix_0 = OpVariable %_ptr_Function_v2float Function
    %depth_1 = OpVariable %_ptr_Function_float Function
%new_origin_0 = OpVariable %_ptr_Function_v3float Function
%relative_pos = OpVariable %_ptr_Function_v3float Function
   %param_39 = OpVariable %_ptr_Function_float Function
   %param_40 = OpVariable %_ptr_Function_v2float Function
   %param_41 = OpVariable %_ptr_Function_bool Function
   %param_42 = OpVariable %_ptr_Function_v2int Function
   %param_43 = OpVariable %_ptr_Function_int Function
               OpLine %1 633 0
               OpStore %counter %int_0
               OpLine %1 645 0
               OpStore %smooth_intersection_0 %false
               OpLine %1 646 0
               OpStore %fraction_step %float_0_100000001
               OpLine %1 648 0
               OpStore %fraction_1 %float_0
               OpLine %1 650 0
       %1078 = OpLoad %v2float %start_pix
               OpStore %pix_0 %1078
               OpLine %1 651 0
               OpStore %depth_1 %float_0
               OpBranch %1080
       %1080 = OpLabel
               OpLine %1 652 0
               OpLoopMerge %1082 %1083 None
               OpBranch %1084
       %1084 = OpLabel
               OpBranchConditional %true %1081 %1082
       %1081 = OpLabel
               OpLine %1 654 0
       %1085 = OpLoad %float %fraction_step
       %1086 = OpLoad %float %fraction_1
       %1087 = OpFAdd %float %1086 %1085
               OpStore %fraction_1 %1087
               OpLine %1 655 0
       %1089 = OpLoad %v3float %origin_0
       %1090 = OpLoad %v3float %direction_2
       %1091 = OpLoad %float %fraction_1
       %1092 = OpVectorTimesScalar %v3float %1090 %1091
       %1093 = OpFAdd %v3float %1089 %1092
               OpStore %new_origin_0 %1093
               OpLine %1 656 0
       %1095 = OpLoad %v3float %new_origin_0
       %1096 = OpFSub %v3float %1095 %403
               OpStore %relative_pos %1096
               OpLine %1 657 0
       %1097 = OpLoad %v3float %relative_pos
       %1098 = OpDot %float %1097 %427
               OpStore %depth_1 %1098
               OpLine %1 658 0
       %1099 = OpLoad %v3float %relative_pos
       %1100 = OpDot %float %1099 %406
       %1101 = OpFDiv %float %1100 %float_45_7142868
       %1103 = OpFDiv %float %1101 %float_2
       %1104 = OpFAdd %float %1103 %float_0_5
       %1105 = OpLoad %1030 %posMat
       %1106 = OpImageQuerySize %v2int %1105
       %1107 = OpCompositeExtract %int %1106 0
       %1108 = OpConvertSToF %float %1107
       %1109 = OpFMul %float %1104 %1108
       %1110 = OpAccessChain %_ptr_Function_float %pix_0 %uint_0
               OpStore %1110 %1109
               OpLine %1 659 0
       %1111 = OpLoad %v3float %relative_pos
       %1112 = OpDot %float %1111 %416
       %1113 = OpFDiv %float %1112 %float_25_7142849
       %1114 = OpFDiv %float %1113 %float_2
       %1115 = OpFAdd %float %1114 %float_0_5
       %1116 = OpLoad %1030 %posMat
       %1117 = OpImageQuerySize %v2int %1116
       %1118 = OpCompositeExtract %int %1117 1
       %1119 = OpConvertSToF %float %1118
       %1120 = OpFMul %float %1115 %1119
       %1121 = OpAccessChain %_ptr_Function_float %pix_0 %uint_1
               OpStore %1121 %1120
               OpLine %1 663 0
       %1123 = OpLoad %float %depth_1
               OpStore %param_39 %1123
       %1125 = OpLoad %v2float %pix_0
               OpStore %param_40 %1125
       %1127 = OpLoad %bool %smooth_intersection_0
               OpStore %param_41 %1127
       %1128 = OpFunctionCall %bool %ssr_intersects_f1_vf2_b1_ %param_39 %param_40 %param_41
       %1129 = OpLoad %bool %param_41
               OpStore %smooth_intersection_0 %1129
               OpSelectionMerge %1131 None
               OpBranchConditional %1128 %1130 %1131
       %1130 = OpLabel
               OpLine %1 668 0
       %1132 = OpLoad %bool %smooth_intersection_0
               OpSelectionMerge %1134 None
               OpBranchConditional %1132 %1133 %1149
       %1133 = OpLabel
               OpLine %1 669 0
       %1135 = OpLoad %v2float %pix_0
       %1136 = OpConvertFToS %v2int %1135
               OpStore %param_42 %1136
       %1138 = OpFunctionCall %v3float %load_norm_vi2_ %param_42
               OpStore %normal_4 %1138
               OpLine %1 670 0
       %1139 = OpLoad %1030 %posMat
       %1140 = OpLoad %v2float %pix_0
       %1141 = OpConvertFToS %v2int %1140
       %1142 = OpImageRead %v4float %1139 %1141
       %1144 = OpCompositeExtract %float %1142 3
       %1145 = OpConvertFToS %int %1144
               OpStore %param_43 %1145
       %1147 = OpFunctionCall %Material %GetMat_i1_ %param_43
               OpStore %material_1 %1147
               OpLine %1 671 0
               OpReturnValue %true
       %1149 = OpLabel
               OpLine %1 673 0
       %1150 = OpLoad %float %fraction_step
       %1151 = OpLoad %float %fraction_1
       %1152 = OpFSub %float %1151 %1150
               OpStore %fraction_1 %1152
               OpLine %1 674 0
               OpReturnValue %false
       %1134 = OpLabel
               OpUnreachable
       %1131 = OpLabel
               OpLine %1 679 0
       %1154 = OpLoad %float %fraction_1
       %1155 = OpFOrdGreaterThan %bool %1154 %float_2
               OpSelectionMerge %1157 None
               OpBranchConditional %1155 %1156 %1157
       %1156 = OpLabel
               OpLine %1 679 0
               OpReturnValue %false
       %1157 = OpLabel
               OpBranch %1083
       %1083 = OpLabel
               OpBranch %1080
       %1082 = OpLabel
       %1159 = OpUndef %bool
               OpReturnValue %1159
               OpFunctionEnd
